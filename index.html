<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Flow - Executive Function Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #1e1b4b;
            --surface: #ffffff;
            --gray-100: #f3f4f6;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--gray-900);
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 32px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .content {
            padding: 40px 32px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        h2 {
            font-size: 26px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 24px;
            text-align: center;
        }

        h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        /* Login */
        .login-form {
            max-width: 450px;
            margin: 0 auto;
            text-align: center;
        }

        .login-title {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-row {
            display: flex;
            gap: 16px;
        }

        .input-row .input-group {
            flex: 1;
        }

        /* Game layout */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 24px;
        }

        .score-sidebar {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 20px;
        }

        .score-item {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            border: 2px solid var(--gray-300);
            transition: all 0.2s;
        }

        .score-item.completed {
            border-color: var(--success);
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
        }

        .score-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 6px;
        }

        /* Game grid 2x2 */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .game-card {
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 200px;
        }

        .game-card:hover:not(.completed) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .game-card.completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
            border-color: var(--success);
            cursor: default;
        }

        .game-card.completed::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--success);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .game-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .game-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .game-desc {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 12px;
        }

        .game-score {
            font-size: 20px;
            font-weight: 700;
            color: var(--success);
            margin-top: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .progress-bar {
            display: flex;
            gap: 6px;
            height: 6px;
            margin-bottom: 20px;
        }

        .progress-segment {
            flex: 1;
            background: var(--gray-300);
            border-radius: 3px;
        }

        .progress-segment.completed {
            background: var(--success);
        }

        .progress-segment.active {
            background: var(--primary);
        }

        .sequence-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .sequence-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gray-300);
            transition: all 0.3s;
        }

        .sequence-dot.active {
            background: var(--primary);
            transform: scale(1.5);
        }

        .game-area {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 32px;
            margin: 20px 0;
            min-height: 350px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--gray-500);
        }

        /* Input display */
        .input-display {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }

        .input-slot {
            width: 42px;
            height: 42px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            background: white;
        }

        .input-slot.filled {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Number grid */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 56px);
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .number-btn {
            width: 56px;
            height: 56px;
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
        }

        .number-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        /* Target area */
        .target-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 320px;
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            margin: 0 auto;
            overflow: hidden;
        }

        .target {
            position: absolute;
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .target:hover {
            transform: scale(1.1);
        }

        .distractor {
            position: absolute;
            width: 50px;
            height: 50px;
            background: var(--error);
            cursor: pointer;
        }

        .stimulus-display {
            font-size: 72px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 32px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Quick feedback that doesn't block UI */
        .quick-feedback {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            animation: quickFade 0.8s;
            pointer-events: none;
            z-index: 100;
        }

        .quick-feedback.success {
            background: var(--success);
        }

        .quick-feedback.error {
            background: var(--error);
        }

        @keyframes quickFade {
            0% { opacity: 0; transform: translateY(-10px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* Report */
        .report-card {
            max-width: 900px;
            margin: 0 auto;
        }

        .report-header {
            text-align: center;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--gray-300);
            margin-bottom: 24px;
        }

        .report-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .report-scores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .report-score-item {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .report-grade {
            font-size: 48px;
            font-weight: 700;
            margin: 12px 0;
        }

        .grade-A { color: var(--success); }
        .grade-B { color: #3b82f6; }
        .grade-C { color: var(--warning); }
        .grade-D { color: #fb923c; }
        .grade-F { color: var(--error); }

        .total-score {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 12px;
            color: white;
            margin-bottom: 24px;
        }

        .total-value {
            font-size: 56px;
            font-weight: 800;
        }

        .skill-tip {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .skill-tip h4 {
            color: #92400e;
            margin-bottom: 8px;
        }

        @media print {
            body { background: white; }
            .btn { display: none !important; }
        }

        @media (max-width: 768px) {
            .game-layout { grid-template-columns: 1fr; }
            .game-grid { grid-template-columns: 1fr; }
            .report-scores { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Neural Flow Executive Function Training</h1>
        </div>
        
        <div class="content">
            <!-- Login -->
            <div id="loginScreen" class="login-form">
                <h2 class="login-title">Welcome!</h2>
                <p>Enter your information to begin training</p>
                
                <div class="input-group">
                    <label class="input-label">First Name</label>
                    <input type="text" class="input-field" id="nameInput" placeholder="Enter your first name">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label class="input-label">Age</label>
                        <input type="number" class="input-field" id="ageInput" placeholder="Your age" min="8" max="18">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Grade</label>
                        <select class="input-field" id="gradeInput">
                            <option value="">Select</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="startApp()" style="width: 100%; margin-top: 20px;">Begin Training</button>
            </div>

            <!-- Game Selection -->
            <div id="gameScreen" style="display: none;">
                <h2>Complete All 4 Training Modules</h2>
                
                <div class="game-layout">
                    <div>
                        <div class="game-grid">
                            <div class="game-card" id="card-memory" onclick="startGame('memory')">
                                <div class="game-icon">🧩</div>
                                <div class="game-title">Working Memory</div>
                                <div class="game-desc">Remember sequences</div>
                                <div class="game-score" id="score-memory" style="display: none;"></div>
                            </div>
                            
                            <div class="game-card" id="card-attention" onclick="startGame('attention')">
                                <div class="game-icon">🎯</div>
                                <div class="game-title">Sustained Attention</div>
                                <div class="game-desc">Focus on targets</div>
                                <div class="game-score" id="score-attention" style="display: none;"></div>
                            </div>
                            
                            <div class="game-card" id="card-flexibility" onclick="startGame('flexibility')">
                                <div class="game-icon">🔄</div>
                                <div class="game-title">Cognitive Flexibility</div>
                                <div class="game-desc">Switch between rules</div>
                                <div class="game-score" id="score-flexibility" style="display: none;"></div>
                            </div>
                            
                            <div class="game-card" id="card-speed" onclick="startGame('speed')">
                                <div class="game-icon">⚡</div>
                                <div class="game-title">Processing Speed</div>
                                <div class="game-desc">Quick decisions</div>
                                <div class="game-score" id="score-speed" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="score-sidebar">
                        <h3>Progress</h3>
                        <div class="score-item" id="sidebar-memory">
                            <div style="font-size: 13px;">🧩 Memory</div>
                            <div class="score-value" id="sidebar-score-memory">—</div>
                        </div>
                        <div class="score-item" id="sidebar-attention">
                            <div style="font-size: 13px;">🎯 Attention</div>
                            <div class="score-value" id="sidebar-score-attention">—</div>
                        </div>
                        <div class="score-item" id="sidebar-flexibility">
                            <div style="font-size: 13px;">🔄 Flexibility</div>
                            <div class="score-value" id="sidebar-score-flexibility">—</div>
                        </div>
                        <div class="score-item" id="sidebar-speed">
                            <div style="font-size: 13px;">⚡ Speed</div>
                            <div class="score-value" id="sidebar-score-speed">—</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report -->
            <div id="reportScreen" style="display: none;">
                <div class="report-card">
                    <div class="report-header">
                        <h2 class="report-title">🏆 Executive Function Report</h2>
                        <p><strong>Student:</strong> <span id="studentName"></span> | 
                           <strong>Age:</strong> <span id="studentAge"></span> | 
                           <strong>Date:</strong> <span id="reportDate"></span></p>
                    </div>
                    
                    <div class="total-score">
                        <div>Total Score (Age-Adjusted)</div>
                        <div class="total-value" id="totalScore">0</div>
                    </div>
                    
                    <div class="report-scores" id="reportScores"></div>
                    
                    <div id="recommendations" style="margin-top: 24px;"></div>
                    
                    <div style="text-align: center; margin-top: 24px;">
                        <h3>Save Your Report</h3>
                        <p><strong>Windows:</strong> Win + Shift + S | 
                           <strong>Chromebook:</strong> Ctrl + Shift + Overview | 
                           <strong>Mac:</strong> Cmd + Shift + 4</p>
                        <button class="btn" onclick="window.print()">Print Report</button>
                        <button class="btn btn-secondary" onclick="resetApp()">Start Over</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <h2 id="gameTitle" style="text-align: center; margin-bottom: 20px;"></h2>
            <div class="progress-bar" id="progressBar"></div>
            <div class="game-area" id="gameArea"></div>
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="exitToMenu()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            userName: '',
            userAge: 12,
            scores: { memory: null, attention: null, flexibility: null, speed: null },
            currentGame: null,
            currentTask: 0,
            taskResults: [],
            clickLock: false
        };

        // Prevent double clicks globally
        function lockClicks(duration = 300) {
            state.clickLock = true;
            setTimeout(() => { state.clickLock = false; }, duration);
        }

        function startApp() {
            const name = document.getElementById('nameInput').value.trim();
            const age = parseInt(document.getElementById('ageInput').value);
            const grade = document.getElementById('gradeInput').value;
            
            if (!name || !age || !grade) {
                alert('Please fill in all fields');
                return;
            }
            
            state.userName = name;
            state.userAge = age;
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
        }

        function startGame(type) {
            if (state.scores[type] !== null || state.clickLock) return;
            lockClicks();
            
            state.currentGame = type;
            state.currentTask = 0;
            state.taskResults = [];
            
            document.getElementById('gameModal').style.display = 'flex';
            document.getElementById('gameTitle').textContent = {
                memory: '🧩 Working Memory',
                attention: '🎯 Sustained Attention',
                flexibility: '🔄 Cognitive Flexibility',
                speed: '⚡ Processing Speed'
            }[type];
            
            updateProgress();
            runTask();
        }

        function updateProgress() {
            const bar = document.getElementById('progressBar');
            bar.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const seg = document.createElement('div');
                seg.className = 'progress-segment';
                if (i < state.currentTask) seg.classList.add('completed');
                else if (i === state.currentTask) seg.classList.add('active');
                bar.appendChild(seg);
            }
        }

        function runTask() {
            updateProgress();
            const area = document.getElementById('gameArea');
            
            switch(state.currentGame) {
                case 'memory': runMemory(area); break;
                case 'attention': runAttention(area); break;
                case 'flexibility': runFlexibility(area); break;
                case 'speed': runSpeed(area); break;
            }
        }

        // Memory Task
        function runMemory(area) {
            const length = 4 + state.currentTask * 2;
            const sequence = Array.from({length}, () => Math.floor(Math.random() * 10));
            const userInput = [];
            let showIdx = 0;
            
            area.innerHTML = `
                <h3 style="text-align:center;">Remember the sequence</h3>
                <div class="sequence-indicator" id="seqDots"></div>
                <div class="stimulus-display" id="display">Ready...</div>
                <div id="inputArea" style="display:none;">
                    <h3 style="text-align:center;">Enter sequence</h3>
                    <div class="input-display" id="slots"></div>
                    <div class="number-grid">
                        ${[0,1,2,3,4,5,6,7,8,9].map(n => 
                            `<button class="number-btn" onclick="memInput(${n})">${n}</button>`
                        ).join('')}
                    </div>
                    <button class="btn btn-secondary" onclick="memClear()" style="display:block;margin:16px auto;">Clear</button>
                </div>
            `;
            
            // Create dots
            const dots = document.getElementById('seqDots');
            for (let i = 0; i < length; i++) {
                const dot = document.createElement('div');
                dot.className = 'sequence-dot';
                dot.id = `dot-${i}`;
                dots.appendChild(dot);
            }
            
            // Create slots
            const slots = document.getElementById('slots');
            for (let i = 0; i < length; i++) {
                const slot = document.createElement('div');
                slot.className = 'input-slot';
                slot.id = `slot-${i}`;
                slots.appendChild(slot);
            }
            
            // Show sequence
            const interval = setInterval(() => {
                if (showIdx > 0) {
                    document.getElementById(`dot-${showIdx-1}`).classList.remove('active');
                }
                
                if (showIdx < sequence.length) {
                    document.getElementById('display').textContent = sequence[showIdx];
                    document.getElementById(`dot-${showIdx}`).classList.add('active');
                    showIdx++;
                } else {
                    clearInterval(interval);
                    document.getElementById('display').style.display = 'none';
                    document.getElementById('seqDots').style.display = 'none';
                    document.getElementById('inputArea').style.display = 'block';
                }
            }, 800);
            
            window.memInput = (n) => {
                if (state.clickLock || userInput.length >= length) return;
                lockClicks(100);
                
                userInput.push(n);
                document.getElementById(`slot-${userInput.length-1}`).textContent = n;
                document.getElementById(`slot-${userInput.length-1}`).classList.add('filled');
                
                if (userInput.length === length) {
                    let correct = 0;
                    userInput.forEach((v, i) => { if (v === sequence[i]) correct++; });
                    
                    const score = (correct / length) * 80 + (correct === length ? 20 : 0);
                    state.taskResults.push(score);
                    
                    showQuickFeedback(area, correct === length);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < 3) runTask();
                        else endGame();
                    }, 1000);
                }
            };
            
            window.memClear = () => {
                if (state.clickLock) return;
                userInput.length = 0;
                document.querySelectorAll('.input-slot').forEach(s => {
                    s.textContent = '';
                    s.classList.remove('filled');
                });
            };
        }

        // Attention Task - Fixed scoring
        function runAttention(area) {
            let score = 0;
            let hits = 0;
            const targets = 6;
            const distractors = 4;
            let shown = 0;
            let active = [];
            
            area.innerHTML = `
                <h3 style="text-align:center;">Click blue circles, avoid red squares!</h3>
                <div class="target-area" id="targetArea"></div>
                <div style="text-align:center;">
                    Score: <strong id="score">0</strong> | 
                    Targets: <strong id="hits">0</strong>/${targets}
                </div>
            `;
            
            function spawn() {
                if (hits >= targets || shown >= targets + distractors) {
                    // Final score without extra calculations
                    state.taskResults.push(score);
                    showQuickFeedback(area, score > 50);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < 3) runTask();
                        else endGame();
                    }, 1000);
                    return;
                }
                
                const isTarget = shown < targets;
                const item = document.createElement('div');
                item.className = isTarget ? 'target' : 'distractor';
                item.style.left = Math.random() * 450 + 'px';
                item.style.top = Math.random() * 270 + 'px';
                
                item.onclick = () => {
                    if (state.clickLock) return;
                    lockClicks(100);
                    
                    if (isTarget) {
                        score += 15;
                        hits++;
                    } else {
                        score = Math.max(0, score - 10);
                    }
                    
                    document.getElementById('score').textContent = score;
                    document.getElementById('hits').textContent = hits;
                    item.remove();
                    
                    const idx = active.indexOf(item);
                    if (idx > -1) active.splice(idx, 1);
                };
                
                document.getElementById('targetArea').appendChild(item);
                active.push(item);
                shown++;
                
                setTimeout(() => {
                    if (active.includes(item)) {
                        item.remove();
                        active.splice(active.indexOf(item), 1);
                    }
                }, 1500);
            }
            
            // Spawn items continuously
            const spawnInterval = setInterval(() => {
                if (hits >= targets || shown >= targets + distractors) {
                    clearInterval(spawnInterval);
                } else {
                    spawn();
                }
            }, 600);
        }

        // Flexibility Task - Fixed NaN issue
        function runFlexibility(area) {
            let trial = 0;
            let correct = 0;
            const rules = ['even', 'high'];
            
            function nextTrial() {
                if (trial >= 9) {
                    const score = Math.round((correct / 9) * 100);
                    state.taskResults.push(score);
                    showQuickFeedback(area, score > 60);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < 3) runTask();
                        else endGame();
                    }, 1000);
                    return;
                }
                
                const rule = rules[trial % 2];
                const num = Math.floor(Math.random() * 10);
                
                area.innerHTML = `
                    <h3 style="text-align:center;">Trial ${trial + 1} of 9</h3>
                    <h3 style="text-align:center;color:var(--primary);">
                        Rule: ${rule === 'even' ? 'EVEN or ODD?' : 'HIGH (≥5) or LOW (<5)?'}
                    </h3>
                    <div class="stimulus-display">${num}</div>
                    <div style="display:flex;gap:20px;justify-content:center;">
                        ${rule === 'even' ? `
                            <button class="btn" onclick="flexAnswer(${num % 2 === 0})">Even</button>
                            <button class="btn" onclick="flexAnswer(${num % 2 !== 0})">Odd</button>
                        ` : `
                            <button class="btn" onclick="flexAnswer(${num >= 5})">High</button>
                            <button class="btn" onclick="flexAnswer(${num < 5})">Low</button>
                        `}
                    </div>
                `;
                
                window.flexAnswer = (isCorrect) => {
                    if (state.clickLock) return;
                    lockClicks(500);
                    
                    if (isCorrect) correct++;
                    showQuickFeedback(area, isCorrect);
                    
                    trial++;
                    setTimeout(nextTrial, 500);
                };
            }
            
            nextTrial();
        }

        // Speed Task
        function runSpeed(area) {
            let trial = 0;
            let times = [];
            
            function nextTrial() {
                if (trial >= 6) {
                    const avg = times.reduce((a,b) => a+b, 0) / times.length;
                    const score = Math.max(0, Math.round(100 - avg / 12));
                    state.taskResults.push(score);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < 3) runTask();
                        else endGame();
                    }, 1000);
                    return;
                }
                
                const patterns = ['○●○', '□■□', '△▲△'];
                const correct = patterns[Math.floor(Math.random() * patterns.length)];
                const wrong = patterns.filter(p => p !== correct);
                const opts = [correct, ...wrong].sort(() => Math.random() - 0.5);
                
                area.innerHTML = `
                    <h3 style="text-align:center;">Trial ${trial + 1} of 6</h3>
                    <div style="font-size:48px;text-align:center;margin:24px;">${correct}</div>
                    <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;">
                        ${opts.map(o => 
                            `<button class="btn" style="font-size:28px;padding:16px;" onclick="speedAnswer('${o}','${correct}')">${o}</button>`
                        ).join('')}
                    </div>
                `;
                
                const start = Date.now();
                
                window.speedAnswer = (sel, cor) => {
                    if (state.clickLock) return;
                    lockClicks(500);
                    
                    const time = Date.now() - start;
                    times.push(sel === cor ? time : 2000);
                    showQuickFeedback(area, sel === cor);
                    
                    trial++;
                    setTimeout(nextTrial, 500);
                };
            }
            
            nextTrial();
        }

        function showQuickFeedback(container, success) {
            const fb = document.createElement('div');
            fb.className = `quick-feedback ${success ? 'success' : 'error'}`;
            fb.textContent = success ? '✓' : '✗';
            container.style.position = 'relative';
            container.appendChild(fb);
            setTimeout(() => fb.remove(), 800);
        }

        function endGame() {
            const avg = Math.round(state.taskResults.reduce((a,b) => a+b, 0) / state.taskResults.length);
            state.scores[state.currentGame] = avg;
            
            // Update displays
            document.getElementById(`score-${state.currentGame}`).textContent = `Score: ${avg}`;
            document.getElementById(`score-${state.currentGame}`).style.display = 'block';
            document.getElementById(`card-${state.currentGame}`).classList.add('completed');
            document.getElementById(`sidebar-score-${state.currentGame}`).textContent = avg;
            document.getElementById(`sidebar-${state.currentGame}`).classList.add('completed');
            
            document.getElementById('gameModal').style.display = 'none';
            
            if (Object.values(state.scores).every(s => s !== null)) {
                setTimeout(showReport, 500);
            }
        }

        function exitToMenu() {
            document.getElementById('gameModal').style.display = 'none';
        }

        function showReport() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('reportScreen').style.display = 'block';
            
            document.getElementById('studentName').textContent = state.userName;
            document.getElementById('studentAge').textContent = state.userAge;
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString();
            
            const skills = [
                { key: 'memory', name: 'Working Memory', icon: '🧩' },
                { key: 'attention', name: 'Sustained Attention', icon: '🎯' },
                { key: 'flexibility', name: 'Cognitive Flexibility', icon: '🔄' },
                { key: 'speed', name: 'Processing Speed', icon: '⚡' }
            ];
            
            let total = 0;
            let lowest = null;
            let lowestScore = 100;
            
            document.getElementById('reportScores').innerHTML = skills.map(skill => {
                const score = state.scores[skill.key];
                const grade = score >= 90 ? 'A' : score >= 80 ? 'B' : score >= 70 ? 'C' : score >= 60 ? 'D' : 'F';
                const points = Math.round(score * 1.5);
                total += points;
                
                if (score < lowestScore) {
                    lowestScore = score;
                    lowest = skill;
                }
                
                return `
                    <div class="report-score-item">
                        <div style="font-size:40px;">${skill.icon}</div>
                        <div style="font-weight:600;">${skill.name}</div>
                        <div class="report-grade grade-${grade}">${grade}</div>
                        <div style="color:var(--gray-500);">${score}%</div>
                        <div style="color:var(--primary);font-weight:600;">+${points} pts</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('totalScore').textContent = total;
            
            // Recommendations
            if (lowest) {
                const tips = {
                    memory: 'Practice chunking numbers into groups. Play memory games like Simon Says. Use mnemonics and visualization.',
                    attention: 'Minimize distractions while studying. Take regular breaks. Practice mindfulness exercises.',
                    flexibility: 'Try new activities. Practice switching between different types of homework. Play strategy games.',
                    speed: 'Use timers for tasks. Practice quick decision games. Work on automatic recall of math facts.'
                };
                
                document.getElementById('recommendations').innerHTML = `
                    <div class="skill-tip">
                        <h4>${lowest.icon} Focus Area: ${lowest.name}</h4>
                        <p>${tips[lowest.key]}</p>
                    </div>
                `;
            }
        }

        function resetApp() {
            state.scores = { memory: null, attention: null, flexibility: null, speed: null };
            state.currentTask = 0;
            state.taskResults = [];
            
            document.querySelectorAll('.game-card').forEach(c => c.classList.remove('completed'));
            document.querySelectorAll('.game-score').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.score-value').forEach(s => s.textContent = '—');
            document.querySelectorAll('.score-item').forEach(i => i.classList.remove('completed'));
            
            document.getElementById('reportScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
        }
    </script>
</body>
</html>
