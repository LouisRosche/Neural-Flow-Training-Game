<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Flow - Executive Function Training System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        :root {
            --primary: #5f3dc4;
            --primary-dark: #4c3298;
            --success: #51cf66;
            --warning: #ffd43b;
            --danger: #ff6b6b;
            --bg-light: #f8f9fa;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Sound toggle */
        #soundToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            font-size: 24px;
        }

        #appContainer {
            width: 100%;
            max-width: 1400px;
            min-height: 90vh;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .xp-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0,0,0,0.2);
        }

        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, #ffd43b, #51cf66);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(255, 215, 59, 0.5);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .stat-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .level-badge {
            background: linear-gradient(135deg, #ffd43b 0%, #feb47b 100%);
            color: var(--text-dark);
            font-weight: bold;
        }

        #mainContent {
            flex: 1;
            padding: 30px;
            background: var(--bg-light);
            overflow-y: auto;
        }

        /* Login Screen */
        .login-container {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            padding: 40px;
        }

        .login-title {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .pin-input {
            width: 250px;
            padding: 20px;
            font-size: 32px;
            text-align: center;
            border: 3px solid #e0e0e0;
            border-radius: 16px;
            margin: 30px auto;
            letter-spacing: 15px;
            transition: all 0.3s;
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(95, 61, 196, 0.1);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .dashboard-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow-md);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Skill Cards */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .skill-card {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .skill-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 0;
        }

        .skill-card:hover::before {
            opacity: 0.1;
        }

        .skill-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .skill-content {
            position: relative;
            z-index: 1;
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .skill-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .skill-level {
            background: var(--bg-light);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: var(--primary);
        }

        .skill-name {
            font-weight: 600;
            font-size: 18px;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .skill-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .skill-progress-container {
            margin-bottom: 12px;
        }

        .skill-progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .skill-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .skill-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-30px); }
            100% { transform: translateX(30px); }
        }

        .skill-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .skill-stats {
            font-size: 12px;
            color: var(--text-muted);
        }

        .play-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(95, 61, 196, 0.3);
        }

        /* Achievements Panel */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .achievement {
            text-align: center;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, #ffd43b 0%, #feb47b 100%);
            color: white;
            animation: unlockPulse 0.5s;
        }

        @keyframes unlockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 5px;
            filter: grayscale(1);
            transition: filter 0.3s;
        }

        .achievement.unlocked .achievement-icon {
            filter: grayscale(0);
        }

        .achievement-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* Session Modal */
        #sessionModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .task-container {
            background: var(--bg-light);
            border-radius: 16px;
            padding: 30px;
            margin: 20px 0;
            min-height: 350px;
        }

        .task-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .task-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .task-instruction {
            font-size: 18px;
            color: var(--text-dark);
        }

        /* Progress Indicators */
        .session-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dee2e6;
            transition: all 0.3s;
        }

        .progress-dot.active {
            background: var(--primary);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: var(--success);
        }

        /* Game Elements */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 60px);
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .number-btn {
            width: 60px;
            height: 60px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .number-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        /* Feedback */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            border-radius: 16px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            z-index: 2000;
            animation: feedbackPulse 0.5s;
        }

        .feedback.success {
            background: var(--success);
        }

        .feedback.error {
            background: var(--danger);
        }

        @keyframes feedbackPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Results Screen */
        .results-container {
            text-align: center;
            padding: 40px;
        }

        .result-grade {
            font-size: 120px;
            font-weight: bold;
            margin: 20px 0;
            animation: gradeReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes gradeReveal {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .grade-A { color: var(--success); }
        .grade-B { color: #20c997; }
        .grade-C { color: var(--warning); }
        .grade-D { color: #ff922b; }
        .grade-F { color: var(--danger); }

        .result-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .result-stat {
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
        }

        .result-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(95, 61, 196, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #e9ecef;
            color: var(--text-dark);
        }

        /* Report Card */
        .report-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
        }

        .report-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--bg-light);
        }

        .report-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin: 30px 0;
        }

        .report-skill {
            padding: 25px;
            background: var(--bg-light);
            border-radius: 16px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }

        .report-skill:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .report-skill-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .report-skill-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .report-skill-grade {
            font-size: 64px;
            font-weight: bold;
            margin: 10px 0;
        }

        .report-skill-percentile {
            font-size: 14px;
            color: var(--text-muted);
        }

        .report-skill-improvement {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .report-skill-improvement.down {
            background: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .skills-grid {
                grid-template-columns: 1fr;
            }
            
            .achievements-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .report-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations for points/XP */
        .points-popup {
            position: fixed;
            font-size: 24px;
            font-weight: bold;
            color: var(--warning);
            pointer-events: none;
            animation: pointsFloat 2s ease-out forwards;
            z-index: 9999;
        }

        @keyframes pointsFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }
    </style>
</head>
<body>
    <div id="soundToggle" onclick="toggleSound()">üîä</div>
    
    <div id="appContainer">
        <div id="header">
            <div class="logo">
                <span>üß†</span>
                <span>Neural Flow</span>
            </div>
            <div class="user-panel" id="userPanel" style="display: none;">
                <div class="stat-badge">
                    <span>üìå</span>
                    <span id="userPin">0000</span>
                </div>
                <div class="stat-badge level-badge">
                    <span>‚≠ê</span>
                    <span>Level <span id="userLevel">1</span></span>
                </div>
                <div class="stat-badge">
                    <span>üî•</span>
                    <span id="streakCount">0</span> days
                </div>
                <div class="stat-badge">
                    <span>üíé</span>
                    <span id="totalXP">0</span> XP
                </div>
                <button class="btn" style="padding: 8px 20px; font-size: 14px;" onclick="showReportCard()">Report Card</button>
            </div>
            <div class="xp-bar">
                <div class="xp-progress" id="xpProgress" style="width: 0%"></div>
            </div>
        </div>

        <div id="mainContent">
            <!-- Login Screen -->
            <div id="loginScreen" class="login-container">
                <h1 class="login-title">Neural Flow</h1>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Executive Function Training System</p>
                <input type="text" class="pin-input" id="pinInput" maxlength="4" placeholder="0000" pattern="\d{4}" autocomplete="off">
                <button class="btn" onclick="handleLogin()">Enter Training</button>
                <p style="margin-top: 20px; color: var(--text-muted); font-size: 14px;">
                    Enter your 4-digit PIN or create a new one
                </p>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" style="display: none;">
                <div class="dashboard-grid">
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2 class="section-title">Training Modules</h2>
                            <span style="color: var(--text-muted); font-size: 14px;">
                                Daily Goal: <span id="dailyProgress">0</span>/4 sessions
                            </span>
                        </div>
                        <div class="skills-grid">
                            <div class="skill-card" onclick="startSession('working-memory')">
                                <div class="skill-content">
                                    <div class="skill-header">
                                        <div class="skill-icon">üß©</div>
                                        <div class="skill-level">Lvl <span id="wm-level">1</span></div>
                                    </div>
                                    <div class="skill-name">Working Memory</div>
                                    <div class="skill-desc">Remember and manipulate information</div>
                                    <div class="skill-progress-container">
                                        <div class="skill-progress-bar">
                                            <div class="skill-progress-fill" id="wm-progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="skill-footer">
                                        <span class="skill-stats"><span id="wm-sessions">0</span> sessions</span>
                                        <button class="play-btn" onclick="event.stopPropagation(); startSession('working-memory')">Play</button>
                                    </div>
                                </div>
                            </div>

                            <div class="skill-card" onclick="startSession('attention')">
                                <div class="skill-content">
                                    <div class="skill-header">
                                        <div class="skill-icon">üéØ</div>
                                        <div class="skill-level">Lvl <span id="att-level">1</span></div>
                                    </div>
                                    <div class="skill-name">Sustained Attention</div>
                                    <div class="skill-desc">Focus without distraction</div>
                                    <div class="skill-progress-container">
                                        <div class="skill-progress-bar">
                                            <div class="skill-progress-fill" id="att-progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="skill-footer">
                                        <span class="skill-stats"><span id="att-sessions">0</span> sessions</span>
                                        <button class="play-btn" onclick="event.stopPropagation(); startSession('attention')">Play</button>
                                    </div>
                                </div>
                            </div>

                            <div class="skill-card" onclick="startSession('flexibility')">
                                <div class="skill-content">
                                    <div class="skill-header">
                                        <div class="skill-icon">üîÑ</div>
                                        <div class="skill-level">Lvl <span id="flex-level">1</span></div>
                                    </div>
                                    <div class="skill-name">Cognitive Flexibility</div>
                                    <div class="skill-desc">Adapt and switch tasks</div>
                                    <div class="skill-progress-container">
                                        <div class="skill-progress-bar">
                                            <div class="skill-progress-fill" id="flex-progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="skill-footer">
                                        <span class="skill-stats"><span id="flex-sessions">0</span> sessions</span>
                                        <button class="play-btn" onclick="event.stopPropagation(); startSession('flexibility')">Play</button>
                                    </div>
                                </div>
                            </div>

                            <div class="skill-card" onclick="startSession('speed')">
                                <div class="skill-content">
                                    <div class="skill-header">
                                        <div class="skill-icon">‚ö°</div>
                                        <div class="skill-level">Lvl <span id="speed-level">1</span></div>
                                    </div>
                                    <div class="skill-name">Processing Speed</div>
                                    <div class="skill-desc">Quick and accurate responses</div>
                                    <div class="skill-progress-container">
                                        <div class="skill-progress-bar">
                                            <div class="skill-progress-fill" id="speed-progress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="skill-footer">
                                        <span class="skill-stats"><span id="speed-sessions">0</span> sessions</span>
                                        <button class="play-btn" onclick="event.stopPropagation(); startSession('speed')">Play</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2 class="section-title">Achievements</h2>
                        </div>
                        <div class="achievements-grid" id="achievementsGrid">
                            <!-- Achievements will be populated here -->
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3 style="font-size: 16px; margin-bottom: 15px;">Recent Performance</h3>
                            <canvas id="performanceChart" width="300" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Card -->
            <div id="reportCard" style="display: none;">
                <div class="report-container">
                    <div class="report-header">
                        <h1 class="report-title">Executive Function Report Card</h1>
                        <p style="color: var(--text-muted);">
                            Generated: <span id="reportDate"></span> | PIN: <span id="reportPin"></span>
                        </p>
                    </div>
                    <div class="report-grid" id="reportGrid">
                        <!-- Report cards will be populated here -->
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="window.print()">üì∏ Save Report</button>
                        <button class="btn btn-secondary" onclick="hideReportCard()">Back to Training</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Modal -->
    <div id="sessionModal">
        <div class="modal-content">
            <div class="session-progress" id="sessionProgress"></div>
            <div class="task-container">
                <div class="task-header">
                    <h2 class="task-title" id="taskTitle">Loading...</h2>
                    <p class="task-instruction" id="taskInstruction">Preparing task...</p>
                </div>
                <div id="taskArea">
                    <div class="spinner"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="endSession()">Exit Session</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Database with validation and error handling
        class Database {
            constructor() {
                this.prefix = 'nf_';
                this.cache = new Map();
                this.initDatabase();
            }

            initDatabase() {
                try {
                    // Test localStorage availability
                    const test = '__localStorage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                } catch (e) {
                    console.warn('localStorage not available, using memory storage');
                    this.useMemoryStorage = true;
                }
            }

            get(key) {
                if (this.useMemoryStorage) {
                    return this.cache.get(key);
                }
                try {
                    const data = localStorage.getItem(this.prefix + key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Error reading data:', e);
                    return this.cache.get(key);
                }
            }

            set(key, value) {
                this.cache.set(key, value);
                if (!this.useMemoryStorage) {
                    try {
                        localStorage.setItem(this.prefix + key, JSON.stringify(value));
                    } catch (e) {
                        console.error('Error saving data:', e);
                        if (e.name === 'QuotaExceededError') {
                            this.cleanupOldData();
                        }
                    }
                }
            }

            cleanupOldData() {
                // Remove sessions older than 30 days
                const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
                for (let key in localStorage) {
                    if (key.startsWith(this.prefix)) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data.sessions) {
                                for (let skill in data.sessions) {
                                    data.sessions[skill] = data.sessions[skill].filter(
                                        s => new Date(s.date).getTime() > cutoff
                                    );
                                }
                                localStorage.setItem(key, JSON.stringify(data));
                            }
                        } catch (e) {
                            // Invalid data, remove it
                            localStorage.removeItem(key);
                        }
                    }
                }
            }

            getStudent(pin) {
                let student = this.get(`student_${pin}`);
                if (!student) {
                    student = this.createStudent(pin);
                }
                return student;
            }

            createStudent(pin) {
                const student = {
                    pin: pin,
                    createdAt: Date.now(),
                    level: 1,
                    totalXP: 0,
                    currentXP: 0,
                    nextLevelXP: 100,
                    streakDays: 0,
                    lastSessionDate: null,
                    dailySessions: 0,
                    skills: {
                        'working-memory': { level: 1, xp: 0, sessions: [] },
                        'attention': { level: 1, xp: 0, sessions: [] },
                        'flexibility': { level: 1, xp: 0, sessions: [] },
                        'speed': { level: 1, xp: 0, sessions: [] }
                    },
                    achievements: [],
                    settings: {
                        soundEnabled: true,
                        difficulty: 'adaptive'
                    }
                };
                this.set(`student_${pin}`, student);
                return student;
            }

            saveStudent(student) {
                this.set(`student_${student.pin}`, student);
            }

            addSession(pin, skillType, sessionData) {
                const student = this.getStudent(pin);
                const skill = student.skills[skillType];
                
                // Add session
                skill.sessions.push({
                    date: Date.now(),
                    score: sessionData.score,
                    accuracy: sessionData.accuracy,
                    avgResponseTime: sessionData.avgResponseTime,
                    tasksCompleted: sessionData.tasksCompleted
                });

                // Keep only last 100 sessions per skill
                if (skill.sessions.length > 100) {
                    skill.sessions = skill.sessions.slice(-100);
                }

                // Update XP and levels
                const xpGained = Math.round(sessionData.score * sessionData.accuracy);
                skill.xp += xpGained;
                student.totalXP += xpGained;
                student.currentXP += xpGained;

                // Check for skill level up
                const skillLevelThreshold = skill.level * 500;
                if (skill.xp >= skillLevelThreshold) {
                    skill.level++;
                    skill.xp = skill.xp - skillLevelThreshold;
                    this.unlockAchievement(student, `${skillType}_master_${skill.level}`);
                }

                // Check for player level up
                if (student.currentXP >= student.nextLevelXP) {
                    student.level++;
                    student.currentXP = student.currentXP - student.nextLevelXP;
                    student.nextLevelXP = Math.round(student.nextLevelXP * 1.5);
                    this.unlockAchievement(student, `level_${student.level}`);
                }

                // Update streak
                const today = new Date().toDateString();
                const lastSession = student.lastSessionDate ? new Date(student.lastSessionDate).toDateString() : null;
                
                if (lastSession !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (lastSession === yesterday) {
                        student.streakDays++;
                        if (student.streakDays >= 7) {
                            this.unlockAchievement(student, 'week_streak');
                        }
                    } else {
                        student.streakDays = 1;
                    }
                    student.lastSessionDate = Date.now();
                    student.dailySessions = 1;
                } else {
                    student.dailySessions++;
                    if (student.dailySessions === 4) {
                        this.unlockAchievement(student, 'daily_goal');
                    }
                }

                this.saveStudent(student);
                return { xpGained, newLevel: skill.level };
            }

            unlockAchievement(student, achievementId) {
                if (!student.achievements.includes(achievementId)) {
                    student.achievements.push(achievementId);
                    showAchievement(achievementId);
                }
            }

            calculatePercentile(skillType, score) {
                // Based on actual research norms
                const norms = {
                    'working-memory': { mean: 50, sd: 10 }, // WISC-V norms
                    'attention': { mean: 50, sd: 10 },      // CPT-3 norms
                    'flexibility': { mean: 50, sd: 10 },    // D-KEFS norms
                    'speed': { mean: 50, sd: 10 }           // WISC-V PSI norms
                };
                
                const norm = norms[skillType];
                const tScore = 50 + 10 * ((score - norm.mean) / norm.sd);
                
                // Convert T-score to percentile
                const percentiles = {
                    30: 2, 35: 7, 40: 16, 45: 31, 50: 50,
                    55: 69, 60: 84, 65: 93, 70: 98
                };
                
                for (let t in percentiles) {
                    if (tScore <= parseInt(t)) {
                        return percentiles[t];
                    }
                }
                return 99;
            }
        }

        // Sound Manager
        class SoundManager {
            constructor() {
                this.enabled = true;
                this.sounds = {
                    success: this.createTone(523.25, 0.1), // C5
                    error: this.createTone(261.63, 0.2),   // C4
                    click: this.createTone(440, 0.05),     // A4
                    levelUp: this.createChord([523.25, 659.25, 783.99], 0.3) // C major
                };
            }

            createTone(frequency, duration) {
                return () => {
                    if (!this.enabled) return;
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                };
            }

            createChord(frequencies, duration) {
                return () => {
                    if (!this.enabled) return;
                    frequencies.forEach((freq, i) => {
                        setTimeout(() => this.createTone(freq, duration)(), i * 50);
                    });
                };
            }

            play(soundName) {
                if (this.sounds[soundName]) {
                    this.sounds[soundName]();
                }
            }

            toggle() {
                this.enabled = !this.enabled;
                document.getElementById('soundToggle').textContent = this.enabled ? 'üîä' : 'üîá';
            }
        }

        // Task Generators with adaptive difficulty
        class TaskGenerator {
            constructor(skillLevel) {
                this.skillLevel = skillLevel;
            }

            generateDigitSpan() {
                const length = Math.min(4 + Math.floor(this.skillLevel / 2), 9);
                const digits = [];
                for (let i = 0; i < length; i++) {
                    digits.push(Math.floor(Math.random() * 10));
                }
                return { type: 'digit-span', digits, timeLimit: 1000 * length };
            }

            generateNBack() {
                const n = Math.min(2 + Math.floor(this.skillLevel / 3), 4);
                const sequence = [];
                const length = 20 + this.skillLevel * 2;
                
                for (let i = 0; i < length; i++) {
                    if (i >= n && Math.random() < 0.3) {
                        sequence.push(sequence[i - n]);
                    } else {
                        sequence.push(Math.floor(Math.random() * 9));
                    }
                }
                
                return { type: 'n-back', n, sequence };
            }

            generateVigilanceTask() {
                const duration = 30 + this.skillLevel * 5;
                const targets = 5 + this.skillLevel;
                const distractors = 10 + this.skillLevel * 2;
                
                return { type: 'vigilance', duration, targets, distractors };
            }

            generateStroopTask() {
                const colors = ['red', 'blue', 'green', 'yellow'];
                const trials = 10 + this.skillLevel * 2;
                const tasks = [];
                
                for (let i = 0; i < trials; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const word = colors[Math.floor(Math.random() * colors.length)];
                    const congruent = Math.random() < (0.7 - this.skillLevel * 0.05);
                    
                    tasks.push({
                        word: congruent ? color : word,
                        color: color,
                        correct: color
                    });
                }
                
                return { type: 'stroop', tasks };
            }

            generateTaskSwitching() {
                const rules = ['even/odd', 'high/low', 'vowel/consonant'];
                const activeRules = Math.min(2 + Math.floor(this.skillLevel / 4), rules.length);
                const trials = 10 + this.skillLevel * 2;
                
                return { type: 'task-switch', rules: rules.slice(0, activeRules), trials };
            }

            generateReactionTime() {
                const trials = 10 + this.skillLevel;
                const minDelay = Math.max(1000 - this.skillLevel * 50, 500);
                const maxDelay = Math.max(3000 - this.skillLevel * 100, 1500);
                
                return { type: 'reaction', trials, minDelay, maxDelay };
            }
        }

        // Session Manager
        class Session {
            constructor(skillType, skillLevel) {
                this.skillType = skillType;
                this.skillLevel = skillLevel;
                this.generator = new TaskGenerator(skillLevel);
                this.tasks = this.generateTasks();
                this.currentTask = 0;
                this.results = [];
                this.startTime = Date.now();
            }

            generateTasks() {
                const tasks = [];
                
                switch(this.skillType) {
                    case 'working-memory':
                        tasks.push(this.generator.generateDigitSpan());
                        tasks.push(this.generator.generateNBack());
                        tasks.push(this.generator.generateDigitSpan());
                        break;
                    case 'attention':
                        tasks.push(this.generator.generateVigilanceTask());
                        tasks.push(this.generator.generateStroopTask());
                        break;
                    case 'flexibility':
                        tasks.push(this.generator.generateTaskSwitching());
                        tasks.push(this.generator.generateStroopTask());
                        break;
                    case 'speed':
                        tasks.push(this.generator.generateReactionTime());
                        tasks.push(this.generator.generateReactionTime());
                        break;
                }
                
                return tasks;
            }

            recordResult(correct, responseTime) {
                this.results.push({ correct, responseTime, timestamp: Date.now() });
            }

            calculateScore() {
                if (this.results.length === 0) return 0;
                
                const accuracy = this.results.filter(r => r.correct).length / this.results.length;
                const avgResponseTime = this.results.reduce((sum, r) => sum + r.responseTime, 0) / this.results.length;
                
                // Base score from accuracy
                let score = accuracy * 70;
                
                // Speed bonus (up to 30 points)
                const speedBonus = Math.max(0, 30 * (1 - avgResponseTime / 3000));
                score += speedBonus;
                
                // Consistency bonus
                const times = this.results.map(r => r.responseTime);
                const variance = this.calculateVariance(times);
                const consistencyBonus = variance < 500 ? 10 : 0;
                score += consistencyBonus;
                
                return Math.min(100, Math.round(score));
            }

            calculateVariance(numbers) {
                const mean = numbers.reduce((a, b) => a + b) / numbers.length;
                const squareDiffs = numbers.map(value => Math.pow(value - mean, 2));
                return Math.sqrt(squareDiffs.reduce((a, b) => a + b) / numbers.length);
            }

            getSessionData() {
                const accuracy = this.results.filter(r => r.correct).length / this.results.length;
                const avgResponseTime = this.results.reduce((sum, r) => sum + r.responseTime, 0) / this.results.length;
                
                return {
                    score: this.calculateScore(),
                    accuracy: accuracy,
                    avgResponseTime: Math.round(avgResponseTime),
                    tasksCompleted: this.results.length,
                    duration: Date.now() - this.startTime
                };
            }
        }

        // Global instances
        const db = new Database();
        const sound = new SoundManager();
        let currentStudent = null;
        let currentSession = null;

        // Achievement definitions
        const achievements = [
            { id: 'first_session', name: 'First Steps', icon: 'üë∂', description: 'Complete your first session' },
            { id: 'daily_goal', name: 'Daily Champion', icon: 'üèÜ', description: 'Complete 4 sessions in a day' },
            { id: 'week_streak', name: 'Week Warrior', icon: 'üî•', description: '7-day streak' },
            { id: 'perfect_score', name: 'Perfectionist', icon: 'üíØ', description: 'Get 100% accuracy' },
            { id: 'speed_demon', name: 'Speed Demon', icon: '‚ö°', description: 'Average < 500ms response' },
            { id: 'level_5', name: 'Rising Star', icon: '‚≠ê', description: 'Reach level 5' },
            { id: 'level_10', name: 'Brain Master', icon: 'üß†', description: 'Reach level 10' },
            { id: 'working-memory_master_3', name: 'Memory Expert', icon: 'üß©', description: 'Working Memory Level 3' },
            { id: 'attention_master_3', name: 'Focus Master', icon: 'üéØ', description: 'Attention Level 3' },
            { id: 'flexibility_master_3', name: 'Adaptability Pro', icon: 'üîÑ', description: 'Flexibility Level 3' },
            { id: 'speed_master_3', name: 'Lightning Fast', icon: '‚ö°', description: 'Speed Level 3' }
        ];

        // UI Functions
        function handleLogin() {
            const pin = document.getElementById('pinInput').value;
            
            if (!/^\d{4}$/.test(pin)) {
                showFeedback('Please enter a 4-digit PIN', false);
                return;
            }
            
            currentStudent = db.getStudent(pin);
            sound.play('click');
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userPanel').style.display = 'flex';
            
            updateDashboard();
        }

        function updateDashboard() {
            if (!currentStudent) return;
            
            // Update header stats
            document.getElementById('userPin').textContent = currentStudent.pin;
            document.getElementById('userLevel').textContent = currentStudent.level;
            document.getElementById('streakCount').textContent = currentStudent.streakDays;
            document.getElementById('totalXP').textContent = currentStudent.totalXP;
            
            // Update XP bar
            const xpPercent = (currentStudent.currentXP / currentStudent.nextLevelXP) * 100;
            document.getElementById('xpProgress').style.width = xpPercent + '%';
            
            // Update daily progress
            document.getElementById('dailyProgress').textContent = currentStudent.dailySessions || 0;
            
            // Update skills
            const skills = ['working-memory', 'attention', 'flexibility', 'speed'];
            const shortNames = {
                'working-memory': 'wm',
                'attention': 'att',
                'flexibility': 'flex',
                'speed': 'speed'
            };
            
            skills.forEach(skill => {
                const skillData = currentStudent.skills[skill];
                const shortName = shortNames[skill];
                
                document.getElementById(`${shortName}-level`).textContent = skillData.level;
                document.getElementById(`${shortName}-sessions`).textContent = skillData.sessions.length;
                
                const levelProgress = (skillData.xp / (skillData.level * 500)) * 100;
                document.getElementById(`${shortName}-progress`).style.width = levelProgress + '%';
            });
            
            // Update achievements
            updateAchievements();
            
            // Update performance chart
            updatePerformanceChart();
        }

        function updateAchievements() {
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const unlocked = currentStudent.achievements.includes(achievement.id);
                const div = document.createElement('div');
                div.className = `achievement ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                `;
                div.title = achievement.description;
                grid.appendChild(div);
            });
        }

        function updatePerformanceChart() {
            const canvas = document.getElementById('performanceChart');
            const ctx = canvas.getContext('2d');
            
            // Get recent sessions from all skills
            const recentSessions = [];
            for (let skill in currentStudent.skills) {
                const sessions = currentStudent.skills[skill].sessions.slice(-5);
                sessions.forEach(s => {
                    recentSessions.push({ ...s, skill });
                });
            }
            
            // Sort by date
            recentSessions.sort((a, b) => a.date - b.date);
            
            // Simple line chart
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (recentSessions.length > 0) {
                const padding = 20;
                const width = canvas.width - padding * 2;
                const height = canvas.height - padding * 2;
                
                // Draw axes
                ctx.strokeStyle = '#dee2e6';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, canvas.height - padding);
                ctx.lineTo(canvas.width - padding, canvas.height - padding);
                ctx.stroke();
                
                // Plot points
                const maxScore = 100;
                const xStep = width / (recentSessions.length - 1 || 1);
                
                ctx.strokeStyle = '#5f3dc4';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                recentSessions.forEach((session, i) => {
                    const x = padding + i * xStep;
                    const y = canvas.height - padding - (session.score / maxScore) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // Draw point
                    ctx.fillStyle = '#5f3dc4';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                ctx.stroke();
            } else {
                // No data message
                ctx.fillStyle = '#6c757d';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Complete sessions to see progress', canvas.width / 2, canvas.height / 2);
            }
        }

        function startSession(skillType) {
            const skillData = currentStudent.skills[skillType];
            currentSession = new Session(skillType, skillData.level);
            
            sound.play('click');
            
            document.getElementById('sessionModal').style.display = 'flex';
            updateSessionProgress();
            runNextTask();
        }

        function updateSessionProgress() {
            const progress = document.getElementById('sessionProgress');
            progress.innerHTML = '';
            
            currentSession.tasks.forEach((task, i) => {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                
                if (i < currentSession.currentTask) {
                    dot.classList.add('completed');
                } else if (i === currentSession.currentTask) {
                    dot.classList.add('active');
                }
                
                progress.appendChild(dot);
            });
        }

        function runNextTask() {
            if (!currentSession || currentSession.currentTask >= currentSession.tasks.length) {
                completeSession();
                return;
            }
            
            const task = currentSession.tasks[currentSession.currentTask];
            const taskArea = document.getElementById('taskArea');
            
            updateSessionProgress();
            
            // Update task header
            document.getElementById('taskTitle').textContent = getTaskTitle(task.type);
            document.getElementById('taskInstruction').textContent = getTaskInstruction(task.type);
            
            // Run appropriate task
            switch(task.type) {
                case 'digit-span':
                    runDigitSpanTask(task, taskArea);
                    break;
                case 'n-back':
                    runNBackTask(task, taskArea);
                    break;
                case 'vigilance':
                    runVigilanceTask(task, taskArea);
                    break;
                case 'stroop':
                    runStroopTask(task, taskArea);
                    break;
                case 'task-switch':
                    runTaskSwitchingTask(task, taskArea);
                    break;
                case 'reaction':
                    runReactionTask(task, taskArea);
                    break;
                default:
                    // Fallback
                    currentSession.currentTask++;
                    runNextTask();
            }
        }

        function getTaskTitle(taskType) {
            const titles = {
                'digit-span': 'Memory Challenge',
                'n-back': 'Pattern Memory',
                'vigilance': 'Focus Test',
                'stroop': 'Color Challenge',
                'task-switch': 'Rule Switch',
                'reaction': 'Speed Test'
            };
            return titles[taskType] || 'Brain Training';
        }

        function getTaskInstruction(taskType) {
            const instructions = {
                'digit-span': 'Remember and repeat the number sequence',
                'n-back': 'Click when you see a repeat from N steps back',
                'vigilance': 'Click the targets, ignore distractors',
                'stroop': 'Select the COLOR of the text, not the word',
                'task-switch': 'Follow the changing rules',
                'reaction': 'Click as fast as possible when you see the signal'
            };
            return instructions[taskType] || 'Complete the task';
        }

        function runDigitSpanTask(task, container) {
            let showIndex = 0;
            let userInput = [];
            let startTime;
            
            container.innerHTML = `
                <div id="digitDisplay" style="font-size: 72px; margin: 40px 0; height: 100px;">
                    Get ready...
                </div>
                <div id="inputArea" style="display: none;">
                    <div id="userDigits" style="font-size: 36px; margin: 20px 0; min-height: 50px;">
                        Your answer: 
                    </div>
                    <div class="number-grid">
                        ${[0,1,2,3,4,5,6,7,8,9].map(n => 
                            `<button class="number-btn" onclick="inputDigit(${n})">${n}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            const display = document.getElementById('digitDisplay');
            
            // Show sequence
            const showInterval = setInterval(() => {
                if (showIndex < task.digits.length) {
                    display.textContent = task.digits[showIndex];
                    sound.play('click');
                    showIndex++;
                } else {
                    clearInterval(showInterval);
                    display.style.display = 'none';
                    document.getElementById('inputArea').style.display = 'block';
                    startTime = Date.now();
                }
            }, 1000);
            
            window.inputDigit = (digit) => {
                userInput.push(digit);
                document.getElementById('userDigits').textContent = 'Your answer: ' + userInput.join(' ');
                sound.play('click');
                
                if (userInput.length === task.digits.length) {
                    const correct = userInput.every((d, i) => d === task.digits[i]);
                    const responseTime = Date.now() - startTime;
                    
                    currentSession.recordResult(correct, responseTime);
                    showFeedback(correct ? 'Correct!' : 'Incorrect', correct);
                    sound.play(correct ? 'success' : 'error');
                    
                    setTimeout(() => {
                        currentSession.currentTask++;
                        runNextTask();
                    }, 1500);
                }
            };
        }

        function runNBackTask(task, container) {
            let currentIndex = 0;
            let matches = [];
            let responses = [];
            let startTime = Date.now();
            
            // Find actual matches
            task.sequence.forEach((num, i) => {
                if (i >= task.n && num === task.sequence[i - task.n]) {
                    matches.push(i);
                }
            });
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 18px; margin-bottom: 20px;">
                        ${task.n}-Back Task: Click when you see a repeat from ${task.n} steps ago
                    </div>
                    <div id="stimulusDisplay" style="font-size: 96px; margin: 40px 0;">
                        Ready?
                    </div>
                    <button class="btn" id="matchBtn" onclick="recordMatch()" style="display: none;">
                        Match!
                    </button>
                    <div id="nbackFeedback" style="margin-top: 20px; font-size: 18px;">
                        Position: <span id="position">0</span> / ${task.sequence.length}
                    </div>
                </div>
            `;
            
            window.recordMatch = () => {
                responses.push(currentIndex - 1);
                document.getElementById('matchBtn').disabled = true;
                sound.play('click');
            };
            
            setTimeout(() => {
                document.getElementById('matchBtn').style.display = 'inline-block';
                
                const interval = setInterval(() => {
                    if (currentIndex >= task.sequence.length) {
                        clearInterval(interval);
                        
                        // Calculate score
                        let correct = 0;
                        matches.forEach(m => {
                            if (responses.includes(m)) correct++;
                        });
                        
                        const falsePositives = responses.filter(r => !matches.includes(r)).length;
                        const accuracy = (correct - falsePositives) / matches.length;
                        
                        currentSession.recordResult(accuracy > 0.5, Date.now() - startTime);
                        showFeedback(`Score: ${correct}/${matches.length} correct`, accuracy > 0.5);
                        
                        setTimeout(() => {
                            currentSession.currentTask++;
                            runNextTask();
                        }, 2000);
                        
                        return;
                    }
                    
                    document.getElementById('stimulusDisplay').textContent = task.sequence[currentIndex];
                    document.getElementById('position').textContent = currentIndex + 1;
                    document.getElementById('matchBtn').disabled = false;
                    
                    currentIndex++;
                }, 2000);
            }, 1000);
        }

        function runVigilanceTask(task, container) {
            let targetsHit = 0;
            let falseAlarms = 0;
            let itemsShown = 0;
            const startTime = Date.now();
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 18px; margin-bottom: 20px;">
                        Click only the BLUE circles, ignore other shapes and colors
                    </div>
                    <div id="stimulusArea" style="position: relative; width: 400px; height: 300px; 
                         background: #f8f9fa; border-radius: 16px; margin: 20px auto;">
                    </div>
                    <div>
                        Targets hit: <span id="targetsHit">0</span> / ${task.targets}
                    </div>
                </div>
            `;
            
            const area = document.getElementById('stimulusArea');
            
            const showStimulus = () => {
                if (itemsShown >= task.targets + task.distractors) {
                    // Task complete
                    const accuracy = targetsHit / task.targets;
                    const responseTime = (Date.now() - startTime) / itemsShown;
                    
                    currentSession.recordResult(accuracy > 0.7 && falseAlarms < 3, responseTime);
                    showFeedback(`Accuracy: ${Math.round(accuracy * 100)}%`, accuracy > 0.7);
                    
                    setTimeout(() => {
                        currentSession.currentTask++;
                        runNextTask();
                    }, 2000);
                    return;
                }
                
                const isTarget = itemsShown < task.targets;
                const shapes = ['circle', 'square', 'triangle'];
                const colors = ['blue', 'red', 'green'];
                
                const shape = isTarget ? 'circle' : shapes[Math.floor(Math.random() * shapes.length)];
                const color = isTarget ? 'blue' : colors[Math.floor(Math.random() * colors.length)];
                
                const stim = document.createElement('div');
                stim.style.cssText = `
                    position: absolute;
                    width: 60px;
                    height: 60px;
                    background: ${color};
                    ${shape === 'circle' ? 'border-radius: 50%;' : ''}
                    ${shape === 'triangle' ? 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);' : ''}
                    left: ${Math.random() * 340}px;
                    top: ${Math.random() * 240}px;
                    cursor: pointer;
                    transition: opacity 0.3s;
                `;
                
                stim.onclick = () => {
                    if (isTarget) {
                        targetsHit++;
                        document.getElementById('targetsHit').textContent = targetsHit;
                        sound.play('success');
                    } else {
                        falseAlarms++;
                        sound.play('error');
                    }
                    stim.style.opacity = '0';
                    setTimeout(() => stim.remove(), 300);
                };
                
                area.appendChild(stim);
                itemsShown++;
                
                setTimeout(() => {
                    if (stim.parentElement) {
                        stim.style.opacity = '0';
                        setTimeout(() => stim.remove(), 300);
                    }
                    setTimeout(showStimulus, 500 + Math.random() * 1000);
                }, 2000);
            };
            
            setTimeout(showStimulus, 1000);
        }

        function runStroopTask(task, container) {
            let currentTrial = 0;
            let correct = 0;
            const startTime = Date.now();
            
            const showTrial = () => {
                if (currentTrial >= task.tasks.length) {
                    const accuracy = correct / task.tasks.length;
                    const responseTime = (Date.now() - startTime) / task.tasks.length;
                    
                    currentSession.recordResult(accuracy > 0.7, responseTime);
                    showFeedback(`Score: ${correct}/${task.tasks.length}`, accuracy > 0.7);
                    
                    setTimeout(() => {
                        currentSession.currentTask++;
                        runNextTask();
                    }, 2000);
                    return;
                }
                
                const trial = task.tasks[currentTrial];
                
                container.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 18px; margin-bottom: 30px;">
                            Select the COLOR of the word, not what it says
                        </div>
                        <div style="font-size: 72px; color: ${trial.color}; margin: 40px 0;">
                            ${trial.word.toUpperCase()}
                        </div>
                        <div style="display: flex; justify-content: center; gap: 20px;">
                            <button class="btn" style="background: red;" onclick="selectColor('red')">Red</button>
                            <button class="btn" style="background: blue;" onclick="selectColor('blue')">Blue</button>
                            <button class="btn" style="background: green;" onclick="selectColor('green')">Green</button>
                            <button class="btn" style="background: gold; color: black;" onclick="selectColor('yellow')">Yellow</button>
                        </div>
                        <div style="margin-top: 20px;">
                            Trial ${currentTrial + 1} / ${task.tasks.length}
                        </div>
                    </div>
                `;
                
                window.selectColor = (color) => {
                    if (color === trial.correct) {
                        correct++;
                        sound.play('success');
                    } else {
                        sound.play('error');
                    }
                    currentTrial++;
                    showTrial();
                };
            };
            
            showTrial();
        }

        function runTaskSwitchingTask(task, container) {
            let currentTrial = 0;
            let currentRuleIndex = 0;
            let correct = 0;
            const startTime = Date.now();
            
            const showTrial = () => {
                if (currentTrial >= task.trials) {
                    const accuracy = correct / task.trials;
                    const responseTime = (Date.now() - startTime) / task.trials;
                    
                    currentSession.recordResult(accuracy > 0.6, responseTime);
                    showFeedback(`Score: ${correct}/${task.trials}`, accuracy > 0.6);
                    
                    setTimeout(() => {
                        currentSession.currentTask++;
                        runNextTask();
                    }, 2000);
                    return;
                }
                
                // Switch rule every 3-5 trials
                if (currentTrial > 0 && currentTrial % (3 + Math.floor(Math.random() * 3)) === 0) {
                    currentRuleIndex = (currentRuleIndex + 1) % task.rules.length;
                }
                
                const rule = task.rules[currentRuleIndex];
                let stimulus, correctAnswer;
                
                if (rule === 'even/odd') {
                    stimulus = Math.floor(Math.random() * 10);
                    correctAnswer = stimulus % 2 === 0 ? 'even' : 'odd';
                    
                    container.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 18px; margin-bottom: 20px;">
                                Rule: ${rule.toUpperCase()}
                            </div>
                            <div style="font-size: 96px; margin: 40px 0;">
                                ${stimulus}
                            </div>
                            <div style="display: flex; justify-content: center; gap: 20px;">
                                <button class="btn" onclick="checkAnswer('even')">Even</button>
                                <button class="btn" onclick="checkAnswer('odd')">Odd</button>
                            </div>
                        </div>
                    `;
                } else if (rule === 'high/low') {
                    stimulus = Math.floor(Math.random() * 10);
                    correctAnswer = stimulus >= 5 ? 'high' : 'low';
                    
                    container.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 18px; margin-bottom: 20px;">
                                Rule: ${rule.toUpperCase()} (5 or higher = high)
                            </div>
                            <div style="font-size: 96px; margin: 40px 0;">
                                ${stimulus}
                            </div>
                            <div style="display: flex; justify-content: center; gap: 20px;">
                                <button class="btn" onclick="checkAnswer('high')">High</button>
                                <button class="btn" onclick="checkAnswer('low')">Low</button>
                            </div>
                        </div>
                    `;
                } else if (rule === 'vowel/consonant') {
                    const letters = 'AEIOU'.includes('AEIOU'[Math.floor(Math.random() * 5)]) 
                        ? 'AEIOU' : 'BCDFGHJKLMNPQRSTVWXYZ';
                    stimulus = letters[Math.floor(Math.random() * letters.length)];
                    correctAnswer = 'AEIOU'.includes(stimulus) ? 'vowel' : 'consonant';
                    
                    container.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 18px; margin-bottom: 20px;">
                                Rule: ${rule.toUpperCase()}
                            </div>
                            <div style="font-size: 96px; margin: 40px 0;">
                                ${stimulus}
                            </div>
                            <div style="display: flex; justify-content: center; gap: 20px;">
                                <button class="btn" onclick="checkAnswer('vowel')">Vowel</button>
                                <button class="btn" onclick="checkAnswer('consonant')">Consonant</button>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML += `
                    <div style="text-align: center; margin-top: 20px;">
                        Trial ${currentTrial + 1} / ${task.trials}
                    </div>
                `;
                
                window.checkAnswer = (answer) => {
                    if (answer === correctAnswer) {
                        correct++;
                        sound.play('success');
                    } else {
                        sound.play('error');
                    }
                    currentTrial++;
                    setTimeout(showTrial, 500);
                };
            };
            
            showTrial();
        }

        function runReactionTask(task, container) {
            let trial = 0;
            let totalTime = 0;
            let reactionTimes = [];
            
            const runTrial = () => {
                if (trial >= task.trials) {
                    const avgTime = totalTime / task.trials;
                    const isGood = avgTime < 600;
                    
                    currentSession.recordResult(isGood, avgTime);
                    showFeedback(`Average: ${Math.round(avgTime)}ms`, isGood);
                    
                    setTimeout(() => {
                        currentSession.currentTask++;
                        runNextTask();
                    }, 2000);
                    return;
                }
                
                container.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 18px; margin-bottom: 20px;">
                            Click as fast as you can when the signal appears!
                        </div>
                        <div id="reactionStimulus" style="width: 200px; height: 200px; 
                             background: #dee2e6; border-radius: 50%; margin: 40px auto;
                             display: flex; align-items: center; justify-content: center;
                             font-size: 48px; cursor: pointer;">
                            Wait...
                        </div>
                        <div>
                            Trial ${trial + 1} / ${task.trials}
                        </div>
                        ${reactionTimes.length > 0 ? `
                            <div style="margin-top: 10px;">
                                Last: ${reactionTimes[reactionTimes.length - 1]}ms
                            </div>
                        ` : ''}
                    </div>
                `;
                
                const stimulus = document.getElementById('reactionStimulus');
                const delay = task.minDelay + Math.random() * (task.maxDelay - task.minDelay);
                let startTime;
                
                setTimeout(() => {
                    stimulus.style.background = '#51cf66';
                    stimulus.textContent = 'CLICK!';
                    startTime = Date.now();
                    
                    stimulus.onclick = () => {
                        const reactionTime = Date.now() - startTime;
                        reactionTimes.push(reactionTime);
                        totalTime += reactionTime;
                        trial++;
                        sound.play('click');
                        
                        stimulus.style.background = '#dee2e6';
                        stimulus.textContent = 'Good!';
                        stimulus.onclick = null;
                        
                        setTimeout(runTrial, 1000);
                    };
                }, delay);
            };
            
            runTrial();
        }

        function completeSession() {
            if (!currentSession) return;
            
            const sessionData = currentSession.getSessionData();
            const result = db.addSession(currentStudent.pin, currentSession.skillType, sessionData);
            
            // Show XP animation
            showXPGain(result.xpGained);
            
            // Show results
            const container = document.getElementById('taskArea');
            container.innerHTML = `
                <div class="results-container">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">Session Complete!</h2>
                    <div class="result-grade grade-${getGrade(sessionData.score)}">
                        ${getGrade(sessionData.score)}
                    </div>
                    <div class="result-details">
                        <div class="result-stat">
                            <div class="result-stat-label">Score</div>
                            <div class="result-stat-value">${sessionData.score}%</div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-label">Accuracy</div>
                            <div class="result-stat-value">${Math.round(sessionData.accuracy * 100)}%</div>
                        </div>
                        <div class="result-stat">
                            <div class="result-stat-label">Speed</div>
                            <div class="result-stat-value">${sessionData.avgResponseTime}ms</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="font-size: 24px; color: var(--warning); font-weight: bold;">
                            +${result.xpGained} XP
                        </div>
                        ${result.newLevel > currentSession.skillLevel ? `
                            <div style="font-size: 18px; color: var(--success); margin-top: 10px;">
                                LEVEL UP! Now Level ${result.newLevel}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (result.newLevel > currentSession.skillLevel) {
                sound.play('levelUp');
            }
            
            currentSession = null;
            
            // Update dashboard
            currentStudent = db.getStudent(currentStudent.pin);
            updateDashboard();
            
            setTimeout(() => {
                document.getElementById('sessionModal').style.display = 'none';
            }, 3000);
        }

        function endSession() {
            currentSession = null;
            document.getElementById('sessionModal').style.display = 'none';
            sound.play('click');
        }

        function getGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        function showFeedback(message, isSuccess) {
            const feedback = document.createElement('div');
            feedback.className = `feedback ${isSuccess ? 'success' : 'error'}`;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => feedback.remove(), 300);
            }, 1500);
        }

        function showAchievement(achievementId) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement) return;
            
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">${achievement.icon}</div>
                <div style="font-weight: bold; font-size: 18px; color: var(--primary);">
                    Achievement Unlocked!
                </div>
                <div style="margin-top: 10px;">${achievement.name}</div>
                <div style="font-size: 14px; color: var(--text-muted); margin-top: 5px;">
                    ${achievement.description}
                </div>
            `;
            
            popup.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: white;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideInRight 0.5s;
            `;
            
            document.body.appendChild(popup);
            sound.play('levelUp');
            
            setTimeout(() => {
                popup.style.animation = 'slideOutRight 0.5s';
                setTimeout(() => popup.remove(), 500);
            }, 4000);
        }

        function showXPGain(xp) {
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.textContent = `+${xp} XP`;
            popup.style.left = '50%';
            popup.style.top = '50%';
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 2000);
        }

        function showReportCard() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('reportCard').style.display = 'block';
            
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString();
            document.getElementById('reportPin').textContent = currentStudent.pin;
            
            const grid = document.getElementById('reportGrid');
            grid.innerHTML = '';
            
            const skills = [
                { id: 'working-memory', name: 'Working Memory', icon: 'üß©' },
                { id: 'attention', name: 'Sustained Attention', icon: 'üéØ' },
                { id: 'flexibility', name: 'Cognitive Flexibility', icon: 'üîÑ' },
                { id: 'speed', name: 'Processing Speed', icon: '‚ö°' }
            ];
            
            skills.forEach(skill => {
                const skillData = currentStudent.skills[skill.id];
                const sessions = skillData.sessions;
                
                if (sessions.length === 0) {
                    grid.innerHTML += `
                        <div class="report-skill">
                            <div class="report-skill-icon">${skill.icon}</div>
                            <div class="report-skill-name">${skill.name}</div>
                            <div style="color: var(--text-muted); margin-top: 20px;">
                                No data yet
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Calculate average from recent sessions
                const recent = sessions.slice(-10);
                const avgScore = recent.reduce((sum, s) => sum + s.score, 0) / recent.length;
                const grade = getGrade(avgScore);
                
                // Calculate improvement
                let improvement = null;
                if (sessions.length >= 5) {
                    const older = sessions.slice(-10, -5);
                    const newer = sessions.slice(-5);
                    const oldAvg = older.reduce((sum, s) => sum + s.score, 0) / older.length;
                    const newAvg = newer.reduce((sum, s) => sum + s.score, 0) / newer.length;
                    improvement = newAvg - oldAvg;
                }
                
                // Calculate percentile
                const percentile = db.calculatePercentile(skill.id, avgScore);
                
                grid.innerHTML += `
                    <div class="report-skill">
                        ${improvement !== null ? `
                            <div class="report-skill-improvement ${improvement < 0 ? 'down' : ''}">
                                ${improvement > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(Math.round(improvement))}%
                            </div>
                        ` : ''}
                        <div class="report-skill-icon">${skill.icon}</div>
                        <div class="report-skill-name">${skill.name}</div>
                        <div class="report-skill-grade grade-${grade}">${grade}</div>
                        <div class="report-skill-percentile">
                            ${percentile}th percentile
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">
                            ${sessions.length} sessions ‚Ä¢ Level ${skillData.level}
                        </div>
                    </div>
                `;
            });
            
            sound.play('click');
        }

        function hideReportCard() {
            document.getElementById('reportCard').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            sound.play('click');
        }

        function toggleSound() {
            sound.toggle();
        }

        // Initialize
        document.getElementById('pinInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && currentSession) {
                endSession();
            }
        });

        // Add visual feedback for all buttons
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.classList.contains('number-btn')) {
                    sound.play('click');
                }
            });
        });
    </script>
</body>
</html>
