<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Flow - Executive Function Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        :root {
            --primary: #5e3fb5;
            --primary-light: #8b6ed6;
            --primary-dark: #4a2f91;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--gray-900);
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px 32px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .content {
            padding: 48px 32px;
        }

        /* Typography hierarchy */
        h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 32px;
            text-align: center;
            letter-spacing: -0.5px;
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 16px;
        }

        p {
            font-size: 16px;
            line-height: 1.6;
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        /* Login */
        .login-form {
            max-width: 480px;
            margin: 0 auto;
            text-align: center;
        }

        .login-title {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
        }

        .name-input {
            width: 100%;
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 500;
            border: 3px solid var(--gray-300);
            border-radius: 12px;
            margin: 24px 0;
            text-align: center;
            transition: all 0.2s;
        }

        .name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(94, 63, 181, 0.1);
        }

        /* Main game layout */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 32px;
        }

        .game-section {
            flex: 1;
        }

        .score-sidebar {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 24px;
        }

        .score-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid var(--gray-200);
            transition: all 0.2s;
        }

        .score-item.completed {
            border-color: var(--success);
            background: linear-gradient(to right, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.1));
        }

        .score-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 8px;
        }

        /* Game grid - 2x2 */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .game-card {
            background: white;
            border: 3px solid var(--gray-200);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .game-card:hover:not(.completed) {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .game-card.completed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2));
            border-color: var(--success);
            cursor: not-allowed;
        }

        .game-card.completed::after {
            content: '‚úì';
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--success);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .game-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .game-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .game-desc {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 16px;
        }

        .game-score {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
            margin-top: 16px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 48px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Progress bar with segments */
        .progress-container {
            margin-bottom: 32px;
        }

        .progress-bar {
            display: flex;
            gap: 8px;
            height: 8px;
        }

        .progress-segment {
            flex: 1;
            background: var(--gray-300);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-segment.completed {
            background: var(--success);
        }

        .progress-segment.active {
            background: var(--primary);
        }

        /* Game area */
        .game-area {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 48px;
            margin: 24px 0;
            min-height: 400px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(94, 63, 181, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--gray-600);
        }

        .btn-success {
            background: var(--success);
        }

        /* Number input display */
        .input-display {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 24px 0;
        }

        .input-slot {
            width: 48px;
            height: 48px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            background: white;
        }

        .input-slot.filled {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Number grid */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 64px);
            gap: 12px;
            justify-content: center;
            margin: 24px 0;
        }

        .number-btn {
            width: 64px;
            height: 64px;
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .number-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        /* Target area for attention task */
        .target-area {
            position: relative;
            width: 600px;
            height: 400px;
            background: white;
            border: 3px solid var(--gray-300);
            border-radius: 16px;
            margin: 0 auto;
            overflow: hidden;
        }

        .target {
            position: absolute;
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .target:hover {
            transform: scale(1.1);
        }

        .target.clicked {
            animation: targetHit 0.3s;
        }

        @keyframes targetHit {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }

        .distractor {
            position: absolute;
            width: 60px;
            height: 60px;
            background: var(--error);
            cursor: pointer;
        }

        /* Stimulus display */
        .stimulus-display {
            font-size: 96px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 48px 0;
        }

        /* Feedback */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 24px 48px;
            border-radius: 16px;
            font-size: 24px;
            font-weight: 600;
            color: white;
            z-index: 2000;
            animation: feedbackAnim 0.8s;
        }

        .feedback.success {
            background: var(--success);
        }

        .feedback.error {
            background: var(--error);
        }

        @keyframes feedbackAnim {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Report card */
        .report-card {
            max-width: 900px;
            margin: 0 auto;
        }

        .report-header {
            text-align: center;
            padding-bottom: 32px;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 32px;
        }

        .report-title {
            font-size: 40px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .report-scores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .report-score-item {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 2px solid var(--gray-200);
        }

        .report-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .report-skill-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .report-grade {
            font-size: 56px;
            font-weight: 700;
            margin: 16px 0;
        }

        .grade-A { color: var(--success); }
        .grade-B { color: #3b82f6; }
        .grade-C { color: var(--warning); }
        .grade-D { color: #fb923c; }
        .grade-F { color: var(--error); }

        .report-percentile {
            font-size: 18px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .report-points {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .total-score {
            text-align: center;
            padding: 32px;
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            border-radius: 16px;
            color: white;
            margin-bottom: 32px;
        }

        .total-label {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .total-value {
            font-size: 72px;
            font-weight: 800;
        }

        /* Reaction display */
        .reaction-display {
            width: 200px;
            height: 200px;
            margin: 48px auto;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction-display.waiting {
            background: var(--gray-300);
            color: var(--gray-600);
        }

        .reaction-display.ready {
            background: var(--success);
            color: white;
            animation: pulse 0.5s;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Time display */
        .time-display {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin: 16px 0;
        }

        @media print {
            body { background: white; }
            .btn { display: none; }
            .header { 
                background: var(--primary) !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .game-grid {
                grid-template-columns: 1fr;
            }
            
            .report-scores {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Neural Flow Training System</h1>
        </div>
        
        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen" class="login-form">
                <h2 class="login-title">Welcome!</h2>
                <p>Enter your name to begin executive function training</p>
                <input type="text" class="name-input" id="nameInput" 
                       placeholder="Your first name" maxlength="30" autocomplete="off">
                <button class="btn" onclick="startApp()">Begin Training</button>
            </div>

            <!-- Game Selection Screen -->
            <div id="gameScreen" style="display: none;">
                <h2>Complete All 4 Training Modules</h2>
                
                <div class="game-layout">
                    <div class="game-section">
                        <div class="game-grid">
                            <div class="game-card" id="card-memory" onclick="startGame('memory')">
                                <div class="game-icon">üß©</div>
                                <div class="game-title">Working Memory</div>
                                <div class="game-desc">Remember number sequences</div>
                                <div class="game-score" id="score-memory" style="display: none;"></div>
                            </div>
                            
                            <div class="game-card" id="card-attention" onclick="startGame('attention')">
                                <div class="game-icon">üéØ</div>
                                <div class="game-title">Sustained Attention</div>
                                <div class="game-desc">Focus on targets, avoid distractors</div>
                                <div class="game-score" id="score-attention" style="display: none;"></div>
                            </div>
                            
                            <div class="game-card" id="card-flexibility" onclick="startGame('flexibility')">
                                <div class="game-icon">üîÑ</div>
                                <div class="game-title">Cognitive Flexibility</div>
                                <div class="game-desc">Adapt to changing rules</div>
                                <div class="game-score" id="score-flexibility" style="display: none;"></div>
                            </div>
                            
                            <div class="game-card" id="card-speed" onclick="startGame('speed')">
                                <div class="game-icon">‚ö°</div>
                                <div class="game-title">Processing Speed</div>
                                <div class="game-desc">Make quick decisions</div>
                                <div class="game-score" id="score-speed" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="score-sidebar">
                        <h3>Your Progress</h3>
                        <div class="score-item" id="sidebar-memory">
                            <div style="font-size: 14px; color: var(--gray-600);">üß© Memory</div>
                            <div class="score-value" id="sidebar-score-memory">‚Äî</div>
                        </div>
                        <div class="score-item" id="sidebar-attention">
                            <div style="font-size: 14px; color: var(--gray-600);">üéØ Attention</div>
                            <div class="score-value" id="sidebar-score-attention">‚Äî</div>
                        </div>
                        <div class="score-item" id="sidebar-flexibility">
                            <div style="font-size: 14px; color: var(--gray-600);">üîÑ Flexibility</div>
                            <div class="score-value" id="sidebar-score-flexibility">‚Äî</div>
                        </div>
                        <div class="score-item" id="sidebar-speed">
                            <div style="font-size: 14px; color: var(--gray-600);">‚ö° Speed</div>
                            <div class="score-value" id="sidebar-score-speed">‚Äî</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Screen -->
            <div id="reportScreen" style="display: none;">
                <div class="report-card">
                    <div class="report-header">
                        <h2 class="report-title">üèÜ Executive Function Report</h2>
                        <p style="font-size: 18px;">
                            <strong>Student:</strong> <span id="studentName"></span> | 
                            <strong>Date:</strong> <span id="reportDate"></span>
                        </p>
                    </div>
                    
                    <div class="total-score">
                        <div class="total-label">Total Score</div>
                        <div class="total-value" id="totalScore">0</div>
                    </div>
                    
                    <div class="report-scores" id="reportScores"></div>
                    
                    <div style="text-align: center; margin-top: 32px;">
                        <h3>How to Save Your Report:</h3>
                        <p style="margin: 16px 0;">
                            <strong>Windows:</strong> Press Windows + Shift + S<br>
                            <strong>Chromebook:</strong> Press Ctrl + Shift + Overview<br>
                            <strong>Mac:</strong> Press Cmd + Shift + 4
                        </p>
                        <button class="btn" onclick="window.print()">Print Report</button>
                        <button class="btn btn-secondary" onclick="resetApp()">Start Over</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <h2 id="gameTitle" style="text-align: center; margin-bottom: 24px;"></h2>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="game-area" id="gameArea"></div>
            
            <div style="text-align: center;">
                <button class="btn btn-secondary" id="exitBtn" onclick="exitGame()">Exit Training</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const state = {
            userName: '',
            scores: {
                memory: null,
                attention: null,
                flexibility: null,
                speed: null
            },
            currentGame: null,
            currentTask: 0,
            totalTasks: 3,
            taskResults: []
        };

        // Start app
        function startApp() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                showFeedback('Please enter your name', false);
                return;
            }
            
            state.userName = name;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
        }

        // Start game
        function startGame(type) {
            if (state.scores[type] !== null) {
                showFeedback('Already completed!', false);
                return;
            }
            
            state.currentGame = type;
            state.currentTask = 0;
            state.taskResults = [];
            
            document.getElementById('gameModal').style.display = 'flex';
            
            const titles = {
                memory: 'üß© Working Memory Training',
                attention: 'üéØ Sustained Attention Training',
                flexibility: 'üîÑ Cognitive Flexibility Training',
                speed: '‚ö° Processing Speed Training'
            };
            document.getElementById('gameTitle').textContent = titles[type];
            
            updateProgressBar();
            runTask();
        }

        // Update progress bar with segments
        function updateProgressBar() {
            const bar = document.getElementById('progressBar');
            bar.innerHTML = '';
            
            for (let i = 0; i < state.totalTasks; i++) {
                const segment = document.createElement('div');
                segment.className = 'progress-segment';
                if (i < state.currentTask) {
                    segment.classList.add('completed');
                } else if (i === state.currentTask) {
                    segment.classList.add('active');
                }
                bar.appendChild(segment);
            }
        }

        // Run current task
        function runTask() {
            updateProgressBar();
            const area = document.getElementById('gameArea');
            
            switch(state.currentGame) {
                case 'memory':
                    runMemoryTask(area);
                    break;
                case 'attention':
                    runAttentionTask(area);
                    break;
                case 'flexibility':
                    runFlexibilityTask(area);
                    break;
                case 'speed':
                    runSpeedTask(area);
                    break;
            }
        }

        // Memory task with input display
        function runMemoryTask(area) {
            const length = 4 + state.currentTask * 2; // 4, 6, 8
            const sequence = [];
            const userSequence = [];
            
            // Generate unique digits
            while (sequence.length < length) {
                const digit = Math.floor(Math.random() * 10);
                sequence.push(digit);
            }
            
            let showIndex = 0;
            
            area.innerHTML = `
                <h3 style="text-align: center;">Remember the sequence</h3>
                <div class="stimulus-display" id="display">Get ready...</div>
                <div id="inputArea" style="display: none;">
                    <h3 style="text-align: center;">Enter the sequence</h3>
                    <div class="input-display" id="inputDisplay"></div>
                    <div class="number-grid">
                        ${[0,1,2,3,4,5,6,7,8,9].map(n => 
                            `<button class="number-btn" onclick="inputNumber(${n})">${n}</button>`
                        ).join('')}
                    </div>
                    <button class="btn" onclick="clearInput()" style="margin-top: 16px;">Clear</button>
                </div>
            `;
            
            // Create input slots
            const inputDisplay = document.getElementById('inputDisplay');
            for (let i = 0; i < length; i++) {
                const slot = document.createElement('div');
                slot.className = 'input-slot';
                slot.id = `slot-${i}`;
                inputDisplay.appendChild(slot);
            }
            
            // Show sequence
            const interval = setInterval(() => {
                if (showIndex < sequence.length) {
                    document.getElementById('display').textContent = sequence[showIndex];
                    showIndex++;
                } else {
                    clearInterval(interval);
                    document.getElementById('display').style.display = 'none';
                    document.getElementById('inputArea').style.display = 'block';
                }
            }, 1000);
            
            window.inputNumber = (n) => {
                if (userSequence.length < length) {
                    userSequence.push(n);
                    const slot = document.getElementById(`slot-${userSequence.length - 1}`);
                    slot.textContent = n;
                    slot.classList.add('filled');
                    
                    if (userSequence.length === length) {
                        const correct = userSequence.every((val, i) => val === sequence[i]);
                        state.taskResults.push(correct ? 100 : 0);
                        
                        if (!correct) {
                            // Show correct answer
                            setTimeout(() => {
                                showFeedback(`Correct was: ${sequence.join(' ')}`, false);
                            }, 500);
                        } else {
                            showFeedback('Correct!', true);
                        }
                        
                        setTimeout(() => {
                            state.currentTask++;
                            if (state.currentTask < state.totalTasks) {
                                runTask();
                            } else {
                                endGame();
                            }
                        }, 2500);
                    }
                }
            };
            
            window.clearInput = () => {
                userSequence.length = 0;
                document.querySelectorAll('.input-slot').forEach(slot => {
                    slot.textContent = '';
                    slot.classList.remove('filled');
                });
            };
        }

        // Attention task with actual distractors
        function runAttentionTask(area) {
            let score = 0;
            let targetsHit = 0;
            let penalties = 0;
            const totalTargets = 5 + state.currentTask;
            const totalDistractors = 3 + state.currentTask;
            let itemsShown = 0;
            const startTime = Date.now();
            
            area.innerHTML = `
                <h3 style="text-align: center;">Click blue circles, avoid red squares!</h3>
                <div class="target-area" id="targetArea"></div>
                <div style="text-align: center; font-size: 18px;">
                    <span style="color: var(--success);">Score: <strong id="score">0</strong></span> | 
                    <span>Targets: <strong id="hits">0</strong>/${totalTargets}</span> | 
                    <span style="color: var(--error);">Penalties: <strong id="penalties">0</strong></span>
                </div>
            `;
            
            const targetArea = document.getElementById('targetArea');
            
            function showItem() {
                if (targetsHit >= totalTargets || itemsShown >= totalTargets + totalDistractors) {
                    const totalTime = (Date.now() - startTime) / 1000;
                    const finalScore = Math.max(0, score);
                    const speed = targetsHit / totalTime;
                    const adjustedScore = Math.round(finalScore * (1 + speed * 0.1));
                    
                    state.taskResults.push(adjustedScore);
                    showFeedback(`Final Score: ${adjustedScore}`, adjustedScore > 50);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < state.totalTasks) {
                            runTask();
                        } else {
                            endGame();
                        }
                    }, 2000);
                    return;
                }
                
                const isTarget = itemsShown < totalTargets;
                const item = document.createElement('div');
                item.className = isTarget ? 'target' : 'distractor';
                item.style.left = Math.random() * 540 + 'px';
                item.style.top = Math.random() * 340 + 'px';
                
                item.onclick = () => {
                    if (isTarget) {
                        score += 20;
                        targetsHit++;
                        item.classList.add('clicked');
                        document.getElementById('score').textContent = score;
                        document.getElementById('hits').textContent = targetsHit;
                    } else {
                        score -= 10;
                        penalties++;
                        document.getElementById('score').textContent = Math.max(0, score);
                        document.getElementById('penalties').textContent = penalties;
                        showFeedback('-10', false);
                    }
                    setTimeout(() => item.remove(), 300);
                };
                
                targetArea.appendChild(item);
                itemsShown++;
                
                setTimeout(() => {
                    if (item.parentElement) item.remove();
                    setTimeout(showItem, 300 + Math.random() * 700);
                }, 2000);
            }
            
            setTimeout(showItem, 500);
        }

        // Flexibility task with clearer feedback
        function runFlexibilityTask(area) {
            let trial = 0;
            let correct = 0;
            const totalTrials = 10;
            let currentRule = 'even';
            let lastNumber = -1;
            
            function nextTrial() {
                if (trial >= totalTrials) {
                    const score = Math.round((correct / totalTrials) * 100);
                    state.taskResults.push(score);
                    showFeedback(`Final: ${correct}/${totalTrials} correct`, score > 60);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < state.totalTasks) {
                            runTask();
                        } else {
                            endGame();
                        }
                    }, 2000);
                    return;
                }
                
                // Change rule every 3-4 trials
                if (trial > 0 && trial % (3 + Math.floor(Math.random() * 2)) === 0) {
                    currentRule = currentRule === 'even' ? 'high' : 'even';
                }
                
                // Generate number different from last
                let number;
                do {
                    number = Math.floor(Math.random() * 10);
                } while (number === lastNumber);
                lastNumber = number;
                
                area.innerHTML = `
                    <h3 style="text-align: center; color: var(--primary);">
                        Question ${trial + 1} of ${totalTrials}
                    </h3>
                    <h3 style="text-align: center; font-size: 24px; margin: 16px 0;">
                        Rule: ${currentRule === 'even' ? 'EVEN or ODD?' : 'HIGH (‚â•5) or LOW (<5)?'}
                    </h3>
                    <div class="stimulus-display">${number}</div>
                    <div style="display: flex; gap: 24px; justify-content: center;">
                        ${(() => {
                            if (currentRule === 'even') {
                                const isEven = number % 2 === 0;
                                return `
                                    <button class="btn" style="min-width: 180px;" onclick="checkAnswer(${isEven}, true)">Even</button>
                                    <button class="btn" style="min-width: 180px;" onclick="checkAnswer(${!isEven}, false)">Odd</button>
                                `;
                            } else {
                                const isHigh = number >= 5;
                                return `
                                    <button class="btn" style="min-width: 180px;" onclick="checkAnswer(${isHigh}, true)">High (‚â•5)</button>
                                    <button class="btn" style="min-width: 180px;" onclick="checkAnswer(${!isHigh}, false)">Low (<5)</button>
                                `;
                            }
                        })()}
                    </div>
                    <div id="trialFeedback" style="text-align: center; margin-top: 24px; font-size: 20px; font-weight: 600;"></div>
                `;
                
                window.checkAnswer = (isCorrect, buttonChoice) => {
                    const feedbackEl = document.getElementById('trialFeedback');
                    if (isCorrect) {
                        correct++;
                        feedbackEl.innerHTML = '<span style="color: var(--success);">‚úì Correct!</span>';
                    } else {
                        feedbackEl.innerHTML = '<span style="color: var(--error);">‚úó Incorrect</span>';
                    }
                    
                    trial++;
                    setTimeout(nextTrial, 1000);
                };
            }
            
            nextTrial();
        }

        // Processing speed with pattern matching
        function runSpeedTask(area) {
            let trial = 0;
            let times = [];
            const totalTrials = 5;
            
            function nextTrial() {
                if (trial >= totalTrials) {
                    const avgTime = times.reduce((a,b) => a+b, 0) / times.length;
                    const score = Math.max(0, Math.round(100 - (avgTime / 15)));
                    state.taskResults.push(score);
                    showFeedback(`Average: ${Math.round(avgTime)}ms`, avgTime < 800);
                    
                    setTimeout(() => {
                        state.currentTask++;
                        if (state.currentTask < state.totalTasks) {
                            runTask();
                        } else {
                            endGame();
                        }
                    }, 2000);
                    return;
                }
                
                // Generate pattern matching task
                const patterns = ['‚Üë‚Üë‚Üì', '‚Üê‚Üí‚Üê', '‚óè‚óã‚óè', '‚ñ†‚ñ°‚ñ†', '‚òÖ‚òÜ‚òÖ'];
                const correct = patterns[Math.floor(Math.random() * patterns.length)];
                const wrong = patterns.filter(p => p !== correct);
                const options = [correct, wrong[Math.floor(Math.random() * wrong.length)]];
                if (Math.random() < 0.5) options.reverse();
                
                area.innerHTML = `
                    <h3 style="text-align: center;">Match the pattern!</h3>
                    <h3 style="text-align: center; margin-bottom: 8px;">Trial ${trial + 1} of ${totalTrials}</h3>
                    <div class="reaction-display waiting">
                        Wait...
                    </div>
                    <div id="patternArea" style="display: none; text-align: center;">
                        <div style="font-size: 48px; margin: 32px 0;">${correct}</div>
                        <div style="display: flex; gap: 24px; justify-content: center;">
                            ${options.map(opt => 
                                `<button class="btn" style="font-size: 32px; padding: 24px 48px;" 
                                 onclick="checkPattern('${opt}', '${correct}')">${opt}</button>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="time-display" id="timeDisplay"></div>
                `;
                
                const delay = 1000 + Math.random() * 2000;
                let startTime;
                
                setTimeout(() => {
                    document.querySelector('.reaction-display').style.display = 'none';
                    document.getElementById('patternArea').style.display = 'block';
                    startTime = Date.now();
                }, delay);
                
                window.checkPattern = (selected, correct) => {
                    const reactionTime = Date.now() - startTime;
                    if (selected === correct && reactionTime > 150) {
                        times.push(reactionTime);
                        document.getElementById('timeDisplay').innerHTML = 
                            `<span style="color: var(--success);">Time: ${reactionTime}ms</span>`;
                    } else if (selected !== correct) {
                        times.push(2000); // Penalty for wrong answer
                        document.getElementById('timeDisplay').innerHTML = 
                            `<span style="color: var(--error);">Incorrect!</span>`;
                    }
                    
                    trial++;
                    setTimeout(nextTrial, 1500);
                };
            }
            
            nextTrial();
        }

        // End game
        function endGame() {
            const avgScore = Math.round(state.taskResults.reduce((a,b) => a+b, 0) / state.taskResults.length);
            state.scores[state.currentGame] = avgScore;
            
            // Update displays
            document.getElementById(`score-${state.currentGame}`).textContent = `Score: ${avgScore}`;
            document.getElementById(`score-${state.currentGame}`).style.display = 'block';
            document.getElementById(`card-${state.currentGame}`).classList.add('completed');
            
            document.getElementById(`sidebar-score-${state.currentGame}`).textContent = avgScore;
            document.getElementById(`sidebar-${state.currentGame}`).classList.add('completed');
            
            document.getElementById('gameModal').style.display = 'none';
            
            // Check if all complete
            if (Object.values(state.scores).every(score => score !== null)) {
                setTimeout(showReport, 500);
            }
        }

        // Exit game
        function exitGame() {
            if (confirm('Exit training? Your progress will be lost.')) {
                document.getElementById('gameModal').style.display = 'none';
                state.currentTask = 0;
                state.taskResults = [];
            }
        }

        // Show report
        function showReport() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('reportScreen').style.display = 'block';
            
            document.getElementById('studentName').textContent = state.userName;
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString();
            
            const scoresDiv = document.getElementById('reportScores');
            let totalScore = 0;
            
            const skills = [
                { key: 'memory', name: 'Working Memory', icon: 'üß©' },
                { key: 'attention', name: 'Sustained Attention', icon: 'üéØ' },
                { key: 'flexibility', name: 'Cognitive Flexibility', icon: 'üîÑ' },
                { key: 'speed', name: 'Processing Speed', icon: '‚ö°' }
            ];
            
            scoresDiv.innerHTML = skills.map(skill => {
                const score = state.scores[skill.key];
                const grade = getGrade(score);
                const percentile = getPercentile(score);
                const points = Math.round(percentile * 1.5); // Each skill contributes up to 150 points
                totalScore += points;
                
                return `
                    <div class="report-score-item">
                        <div class="report-icon">${skill.icon}</div>
                        <div class="report-skill-name">${skill.name}</div>
                        <div class="report-grade grade-${grade}">${grade}</div>
                        <div class="report-percentile">${percentile}th percentile</div>
                        <div class="report-points">+${points} points</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('totalScore').textContent = totalScore;
            showCelebration();
        }

        // Get grade
        function getGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        // Get percentile
        function getPercentile(score) {
            return Math.min(99, Math.max(1, Math.round(score * 0.85 + 15)));
        }

        // Show feedback
        function showFeedback(message, isSuccess) {
            const existing = document.querySelector('.feedback');
            if (existing) existing.remove();
            
            const feedback = document.createElement('div');
            feedback.className = `feedback ${isSuccess ? 'success' : 'error'}`;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 2000);
        }

        // Show celebration
        function showCelebration() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        width: 12px;
                        height: 12px;
                        background: ${['#5e3fb5', '#22c55e', '#f59e0b', '#3b82f6'][Math.floor(Math.random() * 4)]};
                        left: ${Math.random() * 100}%;
                        top: -20px;
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 10000;
                        animation: fall 3s linear;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
            
            const style = document.createElement('style');
            style.textContent = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
            document.head.appendChild(style);
        }

        // Reset app
        function resetApp() {
            state.scores = { memory: null, attention: null, flexibility: null, speed: null };
            state.currentTask = 0;
            state.taskResults = [];
            
            document.querySelectorAll('.game-card').forEach(card => {
                card.classList.remove('completed');
            });
            document.querySelectorAll('.game-score').forEach(score => {
                score.style.display = 'none';
            });
            document.querySelectorAll('.score-value').forEach(score => {
                score.textContent = '‚Äî';
            });
            document.querySelectorAll('.score-item').forEach(item => {
                item.classList.remove('completed');
            });
            
            document.getElementById('reportScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
        }

        // Enter key support
        document.getElementById('nameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startApp();
        });
    </script>
</body>
</html>
