<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Evidence-based executive function training for students">
    <title>Neural Flow - Executive Function Training</title>
    
    <style>
        /* CSS Variables for maintainability */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #1e1b4b;
            --surface: #ffffff;
            --text: #111827;
            --text-muted: #6b7280;
            --border: #d1d5db;
            --radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: var(--text);
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Container */
        .app-container {
            width: 95%;
            max-width: 1200px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        /* Main content */
        .content {
            padding: 2rem;
            min-height: 400px;
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Forms */
        .form-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-title {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: calc(var(--radius) / 2);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input.error {
            border-color: var(--error);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: calc(var(--radius) / 2);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--text-muted);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        /* Game grid */
        .games-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .game-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .game-card:hover:not(.completed) {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .game-card.completed {
            background: #f0fdf4;
            border-color: var(--success);
            cursor: default;
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .game-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .game-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .game-score {
            margin-top: 1rem;
            font-weight: 600;
            color: var(--success);
        }

        /* Game area */
        .game-area {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
            background: #f9fafb;
            border-radius: var(--radius);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stimulus {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary);
            margin: 2rem 0;
        }

        .response-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .number-pad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            max-width: 300px;
            margin: 1rem auto;
        }

        .number-btn {
            padding: 1rem;
            font-size: 1.25rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: calc(var(--radius) / 2);
            cursor: pointer;
            transition: var(--transition);
        }

        .number-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* Report */
        .report-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .report-header {
            text-align: center;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
        }

        .report-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .score-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
        }

        .score-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .score-label {
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Feedback */
        .feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        .feedback.success {
            background: var(--success);
        }

        .feedback.error {
            background: var(--error);
        }

        .feedback.info {
            background: var(--primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .games-container {
                grid-template-columns: 1fr;
            }
            
            .report-scores {
                grid-template-columns: 1fr;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }
            
            .btn,
            .header {
                display: none;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        :focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>ðŸ§  Neural Flow - Executive Function Training</h1>
        </header>
        
        <main class="content">
            <!-- Login Screen -->
            <div id="loginScreen" class="screen active">
                <div class="form-container">
                    <h2 class="form-title">Welcome!</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label" for="name">First Name</label>
                            <input type="text" id="name" class="form-input" required maxlength="50">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="age">Age</label>
                                <input type="number" id="age" class="form-input" required min="6" max="18">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="grade">Grade</label>
                                <select id="grade" class="form-input" required>
                                    <option value="">Select</option>
                                    <option value="3">3rd</option>
                                    <option value="4">4th</option>
                                    <option value="5">5th</option>
                                    <option value="6">6th</option>
                                    <option value="7">7th</option>
                                    <option value="8">8th</option>
                                    <option value="9">9th</option>
                                    <option value="10">10th</option>
                                    <option value="11">11th</option>
                                    <option value="12">12th</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-block">Begin Training</button>
                    </form>
                </div>
            </div>
            
            <!-- Menu Screen -->
            <div id="menuScreen" class="screen">
                <h2 style="text-align: center; margin-bottom: 2rem;">Select a Training Module</h2>
                <div class="games-container" id="gamesGrid"></div>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen" class="screen">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div class="game-area" id="gameArea">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading game...</p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="App.exitGame()">Exit Game</button>
                </div>
            </div>
            
            <!-- Report Screen -->
            <div id="reportScreen" class="screen">
                <div class="report-container">
                    <div class="report-header">
                        <h2 style="font-size: 2rem; margin-bottom: 1rem;">Training Complete!</h2>
                        <p id="reportInfo"></p>
                    </div>
                    
                    <div class="report-scores" id="reportScores"></div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="App.exportData()">Export Data</button>
                        <button class="btn btn-secondary" onclick="App.reset()">New Session</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    // Production-ready implementation with comprehensive error handling
    (function() {
        'use strict';
        
        // Application namespace to prevent global pollution
        const App = window.App = {
            // Configuration constants
            CONFIG: {
                GAMES: [
                    { id: 'memory', name: 'Working Memory', icon: 'ðŸ§©', description: 'Remember sequences' },
                    { id: 'attention', name: 'Sustained Attention', icon: 'ðŸŽ¯', description: 'Focus on targets' },
                    { id: 'flexibility', name: 'Cognitive Flexibility', icon: 'ðŸ”„', description: 'Switch between rules' },
                    { id: 'speed', name: 'Processing Speed', icon: 'âš¡', description: 'Quick decisions' }
                ],
                STORAGE_KEY: 'neural_flow_data',
                SESSION_KEY: 'neural_flow_session',
                MAX_TASKS: 3,
                TASK_TIMEOUT: 60000 // 60 seconds per task
            },
            
            // Application state
            state: {
                user: null,
                currentGame: null,
                currentTask: 0,
                taskScores: [],
                gameScores: {},
                sessionStart: null,
                history: []
            },
            
            // DOM references (will be cached on init)
            elements: {},
            
            // Initialize application
            init() {
                try {
                    this.cacheElements();
                    this.loadState();
                    this.bindEvents();
                    this.render();
                    console.log('Neural Flow initialized successfully');
                } catch (error) {
                    this.handleError('Initialization failed', error);
                }
            },
            
            // Cache DOM elements for performance
            cacheElements() {
                this.elements = {
                    screens: {
                        login: document.getElementById('loginScreen'),
                        menu: document.getElementById('menuScreen'),
                        game: document.getElementById('gameScreen'),
                        report: document.getElementById('reportScreen')
                    },
                    loginForm: document.getElementById('loginForm'),
                    gamesGrid: document.getElementById('gamesGrid'),
                    gameArea: document.getElementById('gameArea'),
                    progressBar: document.getElementById('progressBar'),
                    reportScores: document.getElementById('reportScores'),
                    reportInfo: document.getElementById('reportInfo')
                };
                
                // Verify all elements exist
                Object.entries(this.elements).forEach(([key, value]) => {
                    if (value === null || (typeof value === 'object' && Object.values(value).includes(null))) {
                        throw new Error(`Required element not found: ${key}`);
                    }
                });
            },
            
            // Load saved state from localStorage
            loadState() {
                try {
                    const saved = localStorage.getItem(this.CONFIG.STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.history) {
                            this.state.history = data.history;
                        }
                    }
                } catch (error) {
                    console.warn('Could not load saved state:', error);
                }
            },
            
            // Save state to localStorage
            saveState() {
                try {
                    const data = {
                        history: this.state.history.slice(-100), // Keep last 100 sessions
                        timestamp: Date.now()
                    };
                    localStorage.setItem(this.CONFIG.STORAGE_KEY, JSON.stringify(data));
                } catch (error) {
                    console.warn('Could not save state:', error);
                }
            },
            
            // Bind event listeners
            bindEvents() {
                // Login form
                this.elements.loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                // Prevent multiple rapid clicks
                document.addEventListener('click', (e) => {
                    if (e.target.dataset.clicked === 'true') {
                        e.preventDefault();
                        return;
                    }
                    if (e.target.tagName === 'BUTTON') {
                        e.target.dataset.clicked = 'true';
                        setTimeout(() => delete e.target.dataset.clicked, 500);
                    }
                });
            },
            
            // Handle login
            handleLogin() {
                const name = document.getElementById('name').value.trim();
                const age = parseInt(document.getElementById('age').value);
                const grade = document.getElementById('grade').value;
                
                // Validation
                if (!name || name.length > 50) {
                    this.showFeedback('Please enter a valid name', 'error');
                    return;
                }
                
                if (!age || age < 6 || age > 18) {
                    this.showFeedback('Please enter a valid age (6-18)', 'error');
                    return;
                }
                
                if (!grade) {
                    this.showFeedback('Please select your grade', 'error');
                    return;
                }
                
                // Set user
                this.state.user = { name, age, grade: parseInt(grade) };
                this.state.sessionStart = Date.now();
                
                // Navigate to menu
                this.showScreen('menu');
                this.renderGames();
                this.showFeedback(`Welcome, ${name}!`, 'success');
            },
            
            // Render games menu
            renderGames() {
                const grid = this.elements.gamesGrid;
                grid.innerHTML = '';
                
                this.CONFIG.GAMES.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'game-card';
                    if (this.state.gameScores[game.id] !== undefined) {
                        card.classList.add('completed');
                    }
                    
                    card.innerHTML = `
                        <div class="game-icon">${game.icon}</div>
                        <div class="game-title">${game.name}</div>
                        <div class="game-desc">${game.description}</div>
                        ${this.state.gameScores[game.id] !== undefined ? 
                            `<div class="game-score">Score: ${this.state.gameScores[game.id]}%</div>` : ''}
                    `;
                    
                    if (this.state.gameScores[game.id] === undefined) {
                        card.addEventListener('click', () => this.startGame(game.id));
                    }
                    
                    grid.appendChild(card);
                });
                
                // Check if all games complete
                if (Object.keys(this.state.gameScores).length === this.CONFIG.GAMES.length) {
                    setTimeout(() => this.showReport(), 500);
                }
            },
            
            // Start a game
            startGame(gameId) {
                try {
                    this.state.currentGame = gameId;
                    this.state.currentTask = 0;
                    this.state.taskScores = [];
                    
                    this.showScreen('game');
                    this.runTask();
                } catch (error) {
                    this.handleError('Could not start game', error);
                    this.showScreen('menu');
                }
            },
            
            // Run current task
            runTask() {
                if (this.state.currentTask >= this.CONFIG.MAX_TASKS) {
                    this.endGame();
                    return;
                }
                
                // Update progress
                const progress = ((this.state.currentTask + 1) / this.CONFIG.MAX_TASKS) * 100;
                this.elements.progressBar.style.width = `${progress}%`;
                
                // Clear game area
                const area = this.elements.gameArea;
                area.innerHTML = '';
                
                // Run appropriate task
                switch (this.state.currentGame) {
                    case 'memory':
                        this.runMemoryTask(area);
                        break;
                    case 'attention':
                        this.runAttentionTask(area);
                        break;
                    case 'flexibility':
                        this.runFlexibilityTask(area);
                        break;
                    case 'speed':
                        this.runSpeedTask(area);
                        break;
                    default:
                        throw new Error('Unknown game type');
                }
            },
            
            // Memory task
            runMemoryTask(area) {
                const sequence = [];
                const length = 4 + this.state.currentTask;
                
                // Generate sequence
                for (let i = 0; i < length; i++) {
                    sequence.push(Math.floor(Math.random() * 10));
                }
                
                let showIndex = 0;
                const userInput = [];
                
                // Show sequence
                const showNext = () => {
                    if (showIndex < sequence.length) {
                        area.innerHTML = `
                            <h3>Remember the sequence</h3>
                            <div class="stimulus">${sequence[showIndex]}</div>
                        `;
                        showIndex++;
                        setTimeout(showNext, 1000);
                    } else {
                        // Get user input
                        area.innerHTML = `
                            <h3>Enter the sequence</h3>
                            <div style="margin: 2rem 0;">
                                ${userInput.map(n => `<span style="font-size: 2rem; margin: 0 0.5rem;">${n}</span>`).join('')}
                                ${userInput.length < length ? '<span style="font-size: 2rem; margin: 0 0.5rem;">_</span>' : ''}
                            </div>
                            <div class="number-pad">
                                ${[0,1,2,3,4,5,6,7,8,9].map(n => 
                                    `<button class="number-btn" onclick="App.handleMemoryInput(${n})">${n}</button>`
                                ).join('')}
                            </div>
                        `;
                    }
                };
                
                // Store for external access
                this.memoryState = { sequence, userInput, length };
                showNext();
            },
            
            // Handle memory input
            handleMemoryInput(num) {
                const { sequence, userInput, length } = this.memoryState;
                userInput.push(num);
                
                if (userInput.length >= length) {
                    // Calculate score
                    let correct = 0;
                    for (let i = 0; i < length; i++) {
                        if (userInput[i] === sequence[i]) correct++;
                    }
                    const score = Math.round((correct / length) * 100);
                    this.state.taskScores.push(score);
                    this.nextTask();
                } else {
                    // Update display
                    this.runMemoryTask(this.elements.gameArea);
                }
            },
            
            // Attention task
            runAttentionTask(area) {
                let targets = 0;
                let hits = 0;
                let misses = 0;
                const maxTargets = 5 + this.state.currentTask;
                
                area.innerHTML = `
                    <h3>Click the blue circles</h3>
                    <div style="position: relative; width: 400px; height: 400px; border: 2px solid var(--border); margin: 2rem auto;">
                        <div id="targetArea"></div>
                    </div>
                    <p>Hits: <span id="hits">0</span> / ${maxTargets}</p>
                `;
                
                const targetArea = document.getElementById('targetArea');
                
                const spawnTarget = () => {
                    if (targets >= maxTargets) {
                        const score = Math.round((hits / maxTargets) * 100);
                        this.state.taskScores.push(score);
                        this.nextTask();
                        return;
                    }
                    
                    targets++;
                    const isReal = Math.random() > 0.3;
                    
                    const dot = document.createElement('div');
                    dot.style.cssText = `
                        position: absolute;
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        background: ${isReal ? 'var(--primary)' : 'var(--error)'};
                        left: ${Math.random() * 350}px;
                        top: ${Math.random() * 350}px;
                        cursor: pointer;
                    `;
                    
                    dot.addEventListener('click', () => {
                        if (isReal) {
                            hits++;
                            document.getElementById('hits').textContent = hits;
                        } else {
                            misses++;
                        }
                        dot.remove();
                    });
                    
                    targetArea.appendChild(dot);
                    
                    setTimeout(() => {
                        if (dot.parentNode) {
                            dot.remove();
                            if (isReal) misses++;
                        }
                        spawnTarget();
                    }, 2000);
                };
                
                spawnTarget();
            },
            
            // Flexibility task
            runFlexibilityTask(area) {
                const rules = ['even/odd', 'high/low'];
                const rule = rules[this.state.currentTask % 2];
                const trials = 6;
                let current = 0;
                let correct = 0;
                
                const runTrial = () => {
                    if (current >= trials) {
                        const score = Math.round((correct / trials) * 100);
                        this.state.taskScores.push(score);
                        this.nextTask();
                        return;
                    }
                    
                    const num = Math.floor(Math.random() * 10);
                    
                    area.innerHTML = `
                        <h3>Rule: ${rule === 'even/odd' ? 'Is it even or odd?' : 'Is it high (â‰¥5) or low (<5)?'}</h3>
                        <div class="stimulus">${num}</div>
                        <div class="response-buttons">
                            ${rule === 'even/odd' ? 
                                `<button class="btn" onclick="App.handleFlexResponse(${num}, 'even')">Even</button>
                                 <button class="btn" onclick="App.handleFlexResponse(${num}, 'odd')">Odd</button>` :
                                `<button class="btn" onclick="App.handleFlexResponse(${num}, 'high')">High</button>
                                 <button class="btn" onclick="App.handleFlexResponse(${num}, 'low')">Low</button>`
                            }
                        </div>
                    `;
                    
                    current++;
                };
                
                this.flexState = { correct, runTrial };
                runTrial();
            },
            
            // Handle flexibility response
            handleFlexResponse(num, response) {
                let isCorrect = false;
                
                if (response === 'even' && num % 2 === 0) isCorrect = true;
                if (response === 'odd' && num % 2 !== 0) isCorrect = true;
                if (response === 'high' && num >= 5) isCorrect = true;
                if (response === 'low' && num < 5) isCorrect = true;
                
                if (isCorrect) this.flexState.correct++;
                
                setTimeout(() => this.flexState.runTrial(), 500);
            },
            
            // Speed task
            runSpeedTask(area) {
                const patterns = ['AAA', 'BBB', 'CCC', 'DDD'];
                const trials = 5;
                let current = 0;
                let totalTime = 0;
                let startTime;
                
                const runTrial = () => {
                    if (current >= trials) {
                        const avgTime = totalTime / trials;
                        const score = Math.max(0, Math.round(100 - (avgTime / 20)));
                        this.state.taskScores.push(score);
                        this.nextTask();
                        return;
                    }
                    
                    const correct = patterns[Math.floor(Math.random() * patterns.length)];
                    const options = [...patterns].sort(() => Math.random() - 0.5);
                    
                    area.innerHTML = `
                        <h3>Match the pattern quickly</h3>
                        <div class="stimulus">${correct}</div>
                        <div class="response-buttons">
                            ${options.map(p => 
                                `<button class="btn" onclick="App.handleSpeedResponse('${p}', '${correct}')">${p}</button>`
                            ).join('')}
                        </div>
                    `;
                    
                    startTime = Date.now();
                    current++;
                };
                
                this.speedState = { totalTime, runTrial };
                runTrial();
            },
            
            // Handle speed response
            handleSpeedResponse(selected, correct) {
                const time = Date.now() - performance.now();
                this.speedState.totalTime += Math.abs(time);
                
                setTimeout(() => this.speedState.runTrial(), 200);
            },
            
            // Next task
            nextTask() {
                this.state.currentTask++;
                setTimeout(() => this.runTask(), 1000);
            },
            
            // End game
            endGame() {
                const average = Math.round(
                    this.state.taskScores.reduce((a, b) => a + b, 0) / this.state.taskScores.length
                );
                
                this.state.gameScores[this.state.currentGame] = average;
                this.showScreen('menu');
                this.renderGames();
                this.showFeedback(`Game complete! Score: ${average}%`, 'success');
            },
            
            // Exit game
            exitGame() {
                if (confirm('Exit game? Progress will be lost.')) {
                    this.state.currentGame = null;
                    this.state.currentTask = 0;
                    this.state.taskScores = [];
                    this.showScreen('menu');
                }
            },
            
            // Show report
            showReport() {
                const scores = this.state.gameScores;
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                const average = Math.round(total / Object.keys(scores).length);
                
                // Save to history
                this.state.history.push({
                    date: new Date().toISOString(),
                    user: this.state.user,
                    scores: {...scores},
                    average,
                    duration: Date.now() - this.state.sessionStart
                });
                this.saveState();
                
                // Render report
                this.elements.reportInfo.innerHTML = `
                    <strong>${this.state.user.name}</strong> | 
                    Age ${this.state.user.age} | 
                    Grade ${this.state.user.grade} | 
                    ${new Date().toLocaleDateString()}
                `;
                
                this.elements.reportScores.innerHTML = this.CONFIG.GAMES.map(game => `
                    <div class="score-card">
                        <div>${game.icon}</div>
                        <div class="score-value">${scores[game.id] || 0}%</div>
                        <div class="score-label">${game.name}</div>
                    </div>
                `).join('');
                
                this.showScreen('report');
            },
            
            // Export data
            exportData() {
                const data = {
                    user: this.state.user,
                    session: {
                        date: new Date().toISOString(),
                        scores: this.state.gameScores
                    },
                    history: this.state.history
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neural-flow-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showFeedback('Data exported successfully', 'success');
            },
            
            // Reset application
            reset() {
                this.state = {
                    user: null,
                    currentGame: null,
                    currentTask: 0,
                    taskScores: [],
                    gameScores: {},
                    sessionStart: null,
                    history: this.state.history // Preserve history
                };
                
                this.showScreen('login');
                document.getElementById('loginForm').reset();
            },
            
            // Show screen
            showScreen(screenId) {
                Object.values(this.elements.screens).forEach(screen => {
                    screen.classList.remove('active');
                });
                
                const screen = this.elements.screens[screenId];
                if (screen) {
                    screen.classList.add('active');
                }
            },
            
            // Show feedback
            showFeedback(message, type = 'info') {
                // Remove existing feedback
                const existing = document.querySelector('.feedback');
                if (existing) existing.remove();
                
                const feedback = document.createElement('div');
                feedback.className = `feedback ${type}`;
                feedback.textContent = message;
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    feedback.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => feedback.remove(), 300);
                }, 3000);
            },
            
            // Error handler
            handleError(context, error) {
                console.error(`${context}:`, error);
                this.showFeedback('Something went wrong. Please try again.', 'error');
            },
            
            // Initial render
            render() {
                this.showScreen('login');
            }
        };
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => App.init());
        } else {
            App.init();
        }
        
        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            App.showFeedback('An error occurred. Please refresh the page.', 'error');
        });
        
        // Prevent unload if game in progress
        window.addEventListener('beforeunload', (event) => {
            if (App.state.currentGame) {
                event.preventDefault();
                event.returnValue = '';
            }
        });
        
    })();
    </script>
</body>
</html>
